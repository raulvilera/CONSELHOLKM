/*******************************************************************************
 * SISTEMA COMPLETO DE AN√ÅLISE DE DESEMPENHO E RANKING ESCOLAR - APPS SCRIPT
 * 
 * FUNCIONALIDADES:
 * 1. Analisa notas de cada disciplina em cada bimestre
 * 2. Classifica os 20 melhores alunos de cada ano/s√©rie
 * 3. Exibe no cabe√ßalho: "Top 20", "Top 2", "Top 1" e bimestre
 * 4. Para 5¬∫ Conceito: "Top 20", "Top 2", "Top 3", "Top 1"
 * 5. Registra m√©dias na planilha: 1pQsMY7s5tKmylsOI-t4FZqllVHkT2z0d
 *    Aba: "DANCO_DE_DADOS"
 * 
 * CONFIGURA√á√ïES:
 * - Fonte de dados: Planilha "Map√£o" (ID: 1_l2jwbPfDurDbF5DiOxhz0ON9a6zgCt1GRBezn2bCAw)
 * - Destino: Planilha "DANCO_DE_DADOS" (ID: 1pQsMY7s5tKmylsOI-t4FZqllVHkT2z0d)
 * - Intervalos espec√≠ficos para cada s√©rie
 *******************************************************************************/

// ============================================
// CONFIGURA√á√ïES PRINCIPAIS
// ============================================

// IDs das planilhas
const PLANILHA_FONTE_ID = "1_l2jwbPfDurDbF5DiOxhz0ON9a6zgCt1GRBezn2bCAw";
const PLANILHA_DESTINO_ID = "1pQsMY7s5tKmylsOI-t4FZqllVHkT2z0d";

// Nomes das abas
const ABA_FONTE = "Map√£o";
const ABA_DESTINO = "DANCO_DE_DADOS";

// Configura√ß√µes de s√©ries e intervalos
const CONFIG_SERIES = {
  "6¬∫ Ano": {
    nomesAlunos: { inicio: 3, fim: 22, coluna: "D" },
    serie: { inicio: 3, fim: 22, coluna: "E", formato: "6¬∫A" },
    mediaBim3: { inicio: 3, fim: 22, coluna: "H" },
    mediaBim4: { inicio: 3, fim: 22, coluna: "I" },
    mediaGeral: { inicio: 3, fim: 22, coluna: "J" }
  },
  "7¬∫ Ano": {
    nomesAlunos: { inicio: 29, fim: 48, coluna: "D" },
    serie: { inicio: 29, fim: 48, coluna: "E", formato: "7¬∫A" },
    mediaBim3: { inicio: 29, fim: 48, coluna: "H" },
    mediaBim4: { inicio: 29, fim: 48, coluna: "I" },
    mediaGeral: { inicio: 29, fim: 48, coluna: "J" }
  },
  "8¬∫ Ano": {
    nomesAlunos: { inicio: 55, fim: 74, coluna: "D" },
    serie: { inicio: 55, fim: 74, coluna: "E", formato: "8¬∫A" },
    mediaBim3: { inicio: 55, fim: 74, coluna: "H" },
    mediaBim4: { inicio: 55, fim: 74, coluna: "I" },
    mediaGeral: { inicio: 55, fim: 74, coluna: "J" }
  },
  "9¬∫ Ano": {
    nomesAlunos: { inicio: 81, fim: 100, coluna: "D" },
    serie: { inicio: 81, fim: 100, coluna: "E", formato: "9¬∫A" },
    mediaBim3: { inicio: 81, fim: 100, coluna: "H" },
    mediaBim4: { inicio: 81, fim: 100, coluna: "I" },
    mediaGeral: { inicio: 81, fim: 100, coluna: "J" }
  },
  "1¬™ S√©rie": {
    nomesAlunos: { inicio: 107, fim: 126, coluna: "D" },
    serie: { inicio: 107, fim: 126, coluna: "E", formato: "1¬™A" },
    mediaBim3: { inicio: 107, fim: 126, coluna: "H" },
    mediaBim4: { inicio: 107, fim: 126, coluna: "I" },
    mediaGeral: { inicio: 107, fim: 126, coluna: "J" }
  },
  "2¬™ S√©rie": {
    nomesAlunos: { inicio: 133, fim: 152, coluna: "D" },
    serie: { inicio: 133, fim: 152, coluna: "E", formato: "2¬™A" },
    mediaBim3: { inicio: 133, fim: 152, coluna: "H" },
    mediaBim4: { inicio: 133, fim: 152, coluna: "I" },
    mediaGeral: { inicio: 133, fim: 152, coluna: "J" }
  },
  "3¬™ S√©rie": {
    nomesAlunos: { inicio: 159, fim: 178, coluna: "D" },
    serie: { inicio: 159, fim: 178, coluna: "E", formato: "3¬™A" },
    mediaBim3: { inicio: 159, fim: 178, coluna: "H" },
    mediaBim4: { inicio: 159, fim: 178, coluna: "I" },
    mediaGeral: { inicio: 159, fim: 178, coluna: "J" }
  }
};

// Cache para otimiza√ß√£o
const CACHE = {
  sheetFonte: null,
  sheetDestino: null,
  turmasMap: null,
  dadosRanking: {},
  timestampCache: {},
  cacheValidity: 5 * 60 * 1000 // 5 minutos em milissegundos
};

// ============================================
// FUN√á√ïES DE INICIALIZA√á√ÉO E UTILIT√ÅRIOS
// ============================================

/**
 * Inicializa o sistema
 */
function inicializarSistema() {
  try {
    console.log("üöÄ Inicializando Sistema de Ranking...");
    
    // Configurar menu
    criarMenu();
    
    // Configurar triggers
    configurarTriggers();
    
    // Limpar cache antigo
    limparCacheExpirado();
    
    console.log("‚úÖ Sistema inicializado com sucesso!");
    return { status: "success", message: "Sistema inicializado" };
  } catch (error) {
    console.error("‚ùå Erro na inicializa√ß√£o:", error);
    return { status: "error", message: error.toString() };
  }
}

/**
 * Obt√©m a planilha fonte
 */
function getSheetFonte() {
  if (!CACHE.sheetFonte) {
    try {
      const ss = SpreadsheetApp.openById(PLANILHA_FONTE_ID);
      CACHE.sheetFonte = ss.getSheetByName(ABA_FONTE);
      if (!CACHE.sheetFonte) {
        throw new Error(`Aba "${ABA_FONTE}" n√£o encontrada na planilha fonte`);
      }
    } catch (error) {
      throw new Error(`Erro ao acessar planilha fonte: ${error.message}`);
    }
  }
  return CACHE.sheetFonte;
}

/**
 * Obt√©m a planilha de destino
 */
function getSheetDestino() {
  if (!CACHE.sheetDestino) {
    try {
      const ss = SpreadsheetApp.openById(PLANILHA_DESTINO_ID);
      CACHE.sheetDestino = ss.getSheetByName(ABA_DESTINO);
      if (!CACHE.sheetDestino) {
        throw new Error(`Aba "${ABA_DESTINO}" n√£o encontrada na planilha de destino`);
      }
    } catch (error) {
      throw new Error(`Erro ao acessar planilha de destino: ${error.message}`);
    }
  }
  return CACHE.sheetDestino;
}

/**
 * Normaliza strings para compara√ß√£o
 */
function normalizarTexto(texto) {
  if (!texto || typeof texto !== 'string') return "";
  return texto
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, " ")
    .trim()
    .toLowerCase();
}

/**
 * Converte letra da coluna para n√∫mero
 */
function colunaParaNumero(coluna) {
  let numero = 0;
  coluna = coluna.toUpperCase();
  for (let i = 0; i < coluna.length; i++) {
    numero = numero * 26 + (coluna.charCodeAt(i) - 64);
  }
  return numero;
}

/**
 * Converte n√∫mero para letra da coluna
 */
function numeroParaColuna(numero) {
  let coluna = "";
  while (numero > 0) {
    let resto = (numero - 1) % 26;
    coluna = String.fromCharCode(65 + resto) + coluna;
    numero = Math.floor((numero - 1) / 26);
  }
  return coluna;
}

/**
 * Extrai n√∫mero da linha de uma refer√™ncia
 */
function extrairNumeroLinha(referencia) {
  const match = referencia.toString().match(/\d+/);
  return match ? parseInt(match[0], 10) : null;
}

/**
 * Extrai letras da coluna de uma refer√™ncia
 */
function extrairLetrasColuna(referencia) {
  const match = referencia.toString().toUpperCase().match(/^[A-Z]+/);
  return match ? match[0] : null;
}

/**
 * Limpa cache expirado
 */
function limparCacheExpirado() {
  const agora = new Date().getTime();
  for (const key in CACHE.timestampCache) {
    if (agora - CACHE.timestampCache[key] > CACHE.cacheValidity) {
      delete CACHE.dadosRanking[key];
      delete CACHE.timestampCache[key];
    }
  }
}

// ============================================
// MAPA DE TURMAS (CONFIGURA√á√ÉO COMPLETA)
// ============================================

function getTurmasMap() {
  if (CACHE.turmasMap) return CACHE.turmasMap;
  
  CACHE.turmasMap = [
    // 6¬∫ ANO
    { nome: "6¬∫ Ano A", nivel: "fundamental", total: "A8:BC227", intervaloNomes: "A8:A227",
      bimestres: { 1:{inicio:"A8",fim:"BC52"}, 2:{inicio:"A71",fim:"BC110"}, 3:{inicio:"A129",fim:"BC168"}, 4:{inicio:"A188",fim:"BC227"} }
    },
    { nome: "6¬∫ Ano B", nivel: "fundamental", total: "BE8:DG227", intervaloNomes: "BE8:BE227",
      bimestres: {1:{inicio:"BE8",fim:"DG52"},2:{inicio:"BE71",fim:"DG110"},3:{inicio:"BE129",fim:"DG168"},4:{inicio:"BE188",fim:"DG227"}}
    },
    { nome: "6¬∫ Ano C", nivel: "fundamental", total: "DI8:FK227", intervaloNomes: "DI8:DI227",
      bimestres: {1:{inicio:"DI8",fim:"FK52"},2:{inicio:"DI71",fim:"FK110"},3:{inicio:"DI129",fim:"FK168"},4:{inicio:"DI188",fim:"FK227"}}
    },
    { nome: "6¬∫ Ano D", nivel: "fundamental", total: "FM8:HO227", intervaloNomes: "FM8:FM227",
      bimestres: {1:{inicio:"FM8",fim:"HO52"},2:{inicio:"FM71",fim:"HO110"},3:{inicio:"FM129",fim:"HO168"},4:{inicio:"FM188",fim:"HO227"}}
    },
    { nome: "6¬∫ Ano E", nivel: "fundamental", total: "HQ8:JS227", intervaloNomes: "HQ8:HQ227",
      bimestres: {1:{inicio:"HQ8",fim:"JS52"},2:{inicio:"HQ71",fim:"JS110"},3:{inicio:"HQ129",fim:"JS168"},4:{inicio:"HQ188",fim:"JS227"}}
    },
    { nome: "6¬∫ Ano F", nivel: "fundamental", total: "JU8:LW227", intervaloNomes: "JU8:JU227",
      bimestres: {1:{inicio:"JU8",fim:"LW52"},2:{inicio:"JU71",fim:"LW110"},3:{inicio:"JU129",fim:"LW168"},4:{inicio:"JU188",fim:"LW227"}}
    },

    // 7¬∫ ANO
    { nome: "7¬∫ Ano A", nivel: "fundamental", total: "LY8:OA227", intervaloNomes: "LY8:LY227",
      bimestres: {1:{inicio:"LY8",fim:"OA52"},2:{inicio:"LY71",fim:"OA110"},3:{inicio:"LY129",fim:"OA168"},4:{inicio:"LY188",fim:"OA227"}}
    },
    { nome: "7¬∫ Ano B", nivel: "fundamental", total: "OC8:QE227", intervaloNomes: "OC8:OC227",
      bimestres: {1:{inicio:"OC8",fim:"QE52"},2:{inicio:"OC71",fim:"QE110"},3:{inicio:"OC129",fim:"QE168"},4:{inicio:"OC188",fim:"QE227"}}
    },
    { nome: "7¬∫ Ano C", nivel: "fundamental", total: "QG8:SI227", intervaloNomes: "QG8:QG227",
      bimestres: {1:{inicio:"QG8",fim:"SI52"},2:{inicio:"QG71",fim:"SI110"},3:{inicio:"QG129",fim:"SI168"},4:{inicio:"QG188",fim:"SI227"}}
    },
    { nome: "7¬∫ Ano D", nivel: "fundamental", total: "SK8:UM227", intervaloNomes: "SK8:SK227",
      bimestres: {1:{inicio:"SK8",fim:"UM52"},2:{inicio:"SK71",fim:"UM110"},3:{inicio:"SK129",fim:"UM168"},4:{inicio:"SK188",fim:"UM227"}}
    },
    { nome: "7¬∫ Ano E", nivel: "fundamental", total: "UO8:WQ227", intervaloNomes: "UO8:UO227",
      bimestres: {1:{inicio:"UO8",fim:"WQ52"},2:{inicio:"UO71",fim:"WQ110"},3:{inicio:"UO129",fim:"WQ168"},4:{inicio:"UO188",fim:"WQ227"}}
    },
    { nome: "7¬∫ Ano F", nivel: "fundamental", total: "WS8:YU227", intervaloNomes: "WS8:WS227",
      bimestres: {1:{inicio:"WS8",fim:"YU52"},2:{inicio:"WS71",fim:"YU110"},3:{inicio:"WS129",fim:"YU168"},4:{inicio:"WS188",fim:"YU227"}}
    },

    // 8¬∫ ANO
    { nome: "8¬∫ Ano A", nivel: "fundamental", total: "YW8:AAY227", intervaloNomes: "YW8:YW227",
      bimestres: {1:{inicio:"YW8",fim:"AAY52"},2:{inicio:"YW71",fim:"AAY110"},3:{inicio:"YW129",fim:"AAY168"},4:{inicio:"YW188",fim:"AAY227"}}
    },
    { nome: "8¬∫ Ano B", nivel: "fundamental", total: "ABA8:ADC227", intervaloNomes: "ABA8:ABA227",
      bimestres: {1:{inicio:"ABA8",fim:"ADC52"},2:{inicio:"ABA71",fim:"ADC110"},3:{inicio:"ABA129",fim:"ADC168"},4:{inicio:"ABA188",fim:"ADC227"}}
    },
    { nome: "8¬∫ Ano C", nivel: "fundamental", total: "ADE8:AFG227", intervaloNomes: "ADE8:ADE227",
      bimestres: {1:{inicio:"ADE8",fim:"AFG52"},2:{inicio:"ADE71",fim:"AFG110"},3:{inicio:"ADE129",fim:"AFG168"},4:{inicio:"ADE188",fim:"AFG227"}}
    },
    { nome: "8¬∫ Ano D", nivel: "fundamental", total: "AFI8:AHK227", intervaloNomes: "AFI8:AFI227",
      bimestres: {1:{inicio:"AFI8",fim:"AHK52"},2:{inicio:"AFI71",fim:"AHK110"},3:{inicio:"AFI129",fim:"AHK168"},4:{inicio:"AFI188",fim:"AHK227"}}
    },
    { nome: "8¬∫ Ano E", nivel: "fundamental", total: "AHM8:AJO227", intervaloNomes: "AHM8:AHM227",
      bimestres: {1:{inicio:"AHM8",fim:"AJO52"},2:{inicio:"AHM71",fim:"AJO110"},3:{inicio:"AHM129",fim:"AJO168"},4:{inicio:"AHM188",fim:"AJO227"}}
    },

    // 9¬∫ ANO
    { nome: "9¬∫ Ano A", nivel: "fundamental", total: "AJQ8:ALS227", intervaloNomes: "AJQ8:AJQ227",
      bimestres: {1:{inicio:"AJQ8",fim:"ALS52"},2:{inicio:"AJQ71",fim:"ALS110"},3:{inicio:"AJQ129",fim:"ALS168"},4:{inicio:"AJQ188",fim:"ALS227"}}
    },
    { nome: "9¬∫ Ano B", nivel: "fundamental", total: "ALU8:ANW227", intervaloNomes: "ALU8:ALU227",
      bimestres: {1:{inicio:"ALU8",fim:"ANW52"},2:{inicio:"ALU71",fim:"ANW110"},3:{inicio:"ALU129",fim:"ANW168"},4:{inicio:"ALU188",fim:"ANW227"}}
    },
    { nome: "9¬∫ Ano C", nivel: "fundamental", total: "ANY8:AQA227", intervaloNomes: "ANY8:ANY227",
      bimestres: {1:{inicio:"ANY8",fim:"AQA52"},2:{inicio:"ANY71",fim:"AQA110"},3:{inicio:"ANY129",fim:"AQA168"},4:{inicio:"ANY188",fim:"AQA227"}}
    },
    { nome: "9¬∫ Ano D", nivel: "fundamental", total: "AQC8:ASE227", intervaloNomes: "AQC8:AQC227",
      bimestres: {1:{inicio:"AQC8",fim:"ASE52"},2:{inicio:"AQC71",fim:"ASE110"},3:{inicio:"AQC129",fim:"ASE168"},4:{inicio:"AQC188",fim:"ASE227"}}
    },

    // 1¬™ S√âRIE
    { nome: "1¬™ S√©rie A", nivel: "medio", total: "A249:BG479", intervaloNomes: "A249:A479",
      bimestres: {1:{inicio:"A249",fim:"BG294"},2:{inicio:"A308",fim:"BG354"},3:{inicio:"A370",fim:"BG416"},4:{inicio:"A432",fim:"BG479"}}
    },
    { nome: "1¬™ S√©rie B", nivel: "medio", total: "BI249:DO479", intervaloNomes: "BI249:BI479",
      bimestres: {1:{inicio:"BI249",fim:"DO294"},2:{inicio:"BI308",fim:"DO354"},3:{inicio:"BI370",fim:"DO416"},4:{inicio:"BI432",fim:"DO479"}}
    },
    { nome: "1¬™ S√©rie C", nivel: "medio", total: "DQ249:FW479", intervaloNomes: "DQ249:DQ479",
      bimestres: {1:{inicio:"DQ249",fim:"FW294"},2:{inicio:"DQ308",fim:"FW354"},3:{inicio:"DQ370",fim:"FW416"},4:{inicio:"DQ432",fim:"FW479"}}
    },
    { nome: "1¬™ S√©rie D", nivel: "medio", total: "FY249:IE479", intervaloNomes: "FY249:FY479",
      bimestres: {1:{inicio:"FY249",fim:"IE294"},2:{inicio:"FY308",fim:"IE354"},3:{inicio:"FY370",fim:"IE416"},4:{inicio:"FY432",fim:"IE479"}}
    },
    { nome: "1¬™ S√©rie E", nivel: "medio", total: "IG249:KM479", intervaloNomes: "IG249:IG479",
      bimestres: {1:{inicio:"IG249",fim:"KM294"},2:{inicio:"IG308",fim:"KM354"},3:{inicio:"IG370",fim:"KM416"},4:{inicio:"IG432",fim:"KM479"}}
    },
    { nome: "1¬™ S√©rie F", nivel: "medio", total: "KO249:MU479", intervaloNomes: "KO249:KO479",
      bimestres: {1:{inicio:"KO249",fim:"MU294"},2:{inicio:"KO308",fim:"MU354"},3:{inicio:"KO370",fim:"MU416"},4:{inicio:"KO432",fim:"MU479"}}
    },
    { nome: "1¬™ S√©rie G", nivel: "medio", total: "MW249:PC479", intervaloNomes: "MW249:MW479",
      bimestres: {1:{inicio:"MW249",fim:"PC294"},2:{inicio:"MW308",fim:"PC354"},3:{inicio:"MW370",fim:"PC416"},4:{inicio:"MW432",fim:"PC479"}}
    },
    { nome: "1¬™ S√©rie H", nivel: "medio", total: "PE249:RG479", intervaloNomes: "PE249:PE479",
      bimestres: {1:{inicio:"PE249",fim:"RG294"},2:{inicio:"PE308",fim:"RG354"},3:{inicio:"PE370",fim:"RG416"},4:{inicio:"PE432",fim:"RG479"}}
    },
    { nome: "1¬™ S√©rie I", nivel: "medio", total: "RI249:TK479", intervaloNomes: "RI249:RI479",
      bimestres: {1:{inicio:"RI249",fim:"TK294"},2:{inicio:"RI308",fim:"TK354"},3:{inicio:"RI370",fim:"TK416"},4:{inicio:"RI432",fim:"TK479"}}
    },

    // 2¬™ S√âRIE
    { nome: "2¬™ S√©rie A", nivel: "medio", total: "TM249:VW479", intervaloNomes: "TM249:TM479",
      bimestres: {1:{inicio:"TM249",fim:"VW294"},2:{inicio:"TM308",fim:"VW354"},3:{inicio:"TM370",fim:"VW416"},4:{inicio:"TM432",fim:"VW479"}}
    },
    { nome: "2¬™ S√©rie B", nivel: "medio", total: "VY249:YI479", intervaloNomes: "VY249:VY479",
      bimestres: {1:{inicio:"VY249",fim:"YI294"},2:{inicio:"VY308",fim:"YI354"},3:{inicio:"VY370",fim:"YI416"},4:{inicio:"VY432",fim:"YI479"}}
    },
    { nome: "2¬™ S√©rie C", nivel: "medio", total: "YK249:AAD479", intervaloNomes: "YK249:YK479",
      bimestres: {1:{inicio:"YK249",fim:"AAD294"},2:{inicio:"YK308",fim:"AAD354"},3:{inicio:"YK370",fim:"AAD416"},4:{inicio:"YK432",fim:"AAD479"}}
    },
    { nome: "2¬™ S√©rie D", nivel: "medio", total: "AAW249:ADG479", intervaloNomes: "AAW249:AAW479",
      bimestres: {1:{inicio:"AAW249",fim:"ADG294"},2:{inicio:"AAW308",fim:"ADG354"},3:{inicio:"AAW370",fim:"ADG416"},4:{inicio:"AAW432",fim:"ADG479"}}
    },
    { nome: "2¬™ S√©rie E", nivel: "medio", total: "ADI249:AFO479", intervaloNomes: "ADI249:ADI479",
      bimestres: {1:{inicio:"ADI249",fim:"AFO294"},2:{inicio:"ADI308",fim:"AFO354"},3:{inicio:"ADI370",fim:"AFO416"},4:{inicio:"ADI432",fim:"AFO479"}}
    },
    { nome: "2¬™ S√©rie F", nivel: "medio", total: "AFU249:AHS479", intervaloNomes: "AFU249:AFU479",
      bimestres: {1:{inicio:"AFU249",fim:"AHS294"},2:{inicio:"AFU308",fim:"AHS354"},3:{inicio:"AFU370",fim:"AHS416"},4:{inicio:"AFU432",fim:"AHS479"}}
    },
    { nome: "2¬™ S√©rie G", nivel: "medio", total: "AHU249:AJS479", intervaloNomes: "AHU249:AHU479",
      bimestres: {1:{inicio:"AHU249",fim:"AJS294"},2:{inicio:"AHU308",fim:"AJS354"},3:{inicio:"AHU370",fim:"AJS416"},4:{inicio:"AHU432",fim:"AJS479"}}
    },
    { nome: "2¬™ S√©rie H", nivel: "medio", total: "AJU249:ALS479", intervaloNomes: "AJU249:AJU479",
      bimestres: {1:{inicio:"AJU249",fim:"ALS294"},2:{inicio:"AJU308",fim:"ALS354"},3:{inicio:"AJU370",fim:"ALS416"},4:{inicio:"AJU432",fim:"ALS479"}}
    },

    // 3¬™ S√âRIE
    { nome: "3¬™ S√©rie A", nivel: "medio", total: "ALU249:AOE479", intervaloNomes: "ALU249:ALU479",
      bimestres: {1:{inicio:"ALU249",fim:"AOE294"},2:{inicio:"ALU308",fim:"AOE354"},3:{inicio:"ALU370",fim:"AOE416"},4:{inicio:"ALU432",fim:"AOE479"}}
    },
    { nome: "3¬™ S√©rie B", nivel: "medio", total: "AOG249:AQQ479", intervaloNomes: "AOG249:AOG479",
      bimestres: {1:{inicio:"AOG249",fim:"AQQ294"},2:{inicio:"AOG308",fim:"AQQ354"},3:{inicio:"AOG370",fim:"AQQ416"},4:{inicio:"AOG432",fim:"AQQ479"}}
    },
    { nome: "3¬™ S√©rie C", nivel: "medio", total: "AQS249:ATC479", intervaloNomes: "AQS249:AQS479",
      bimestres: {1:{inicio:"AQS249",fim:"ATC294"},2:{inicio:"AQS308",fim:"ATC354"},3:{inicio:"AQS370",fim:"ATC416"},4:{inicio:"AQS432",fim:"ATC479"}}
    },
    { nome: "3¬™ S√©rie D", nivel: "medio", total: "ATE249:AUY479", intervaloNomes: "ATE249:ATE479",
      bimestres: {1:{inicio:"ATE249",fim:"AUY294"},2:{inicio:"ATE308",fim:"AUY354"},3:{inicio:"ATE370",fim:"AUY416"},4:{inicio:"ATE432",fim:"AUY479"}}
    },
    { nome: "3¬™ S√©rie E", nivel: "medio", total: "AVA249:AWU479", intervaloNomes: "AVA249:AVA479",
      bimestres: {1:{inicio:"AVA249",fim:"AWU294"},2:{inicio:"AVA308",fim:"AWU354"},3:{inicio:"AVA370",fim:"AWU416"},4:{inicio:"AVA432",fim:"AWU479"}}
    },
    { nome: "3¬™ S√©rie F", nivel: "medio", total: "AWW249:AYQ479", intervaloNomes: "AWW249:AWW479",
      bimestres: {1:{inicio:"AWW249",fim:"AYQ294"},2:{inicio:"AWW308",fim:"AYQ354"},3:{inicio:"AWW370",fim:"AYQ416"},4:{inicio:"AWW432",fim:"AYQ479"}}
    },
    { nome: "3¬™ S√©rie G", nivel: "medio", total: "AYS249:BAM479", intervaloNomes: "AYS249:AYS479",
      bimestres: {1:{inicio:"AYS249",fim:"BAM294"},2:{inicio:"AYS308",fim:"BAM354"},3:{inicio:"AYS370",fim:"BAM416"},4:{inicio:"AYS432",fim:"BAM479"}}
    },

    // 2¬™ S√âRIE ADM
    { nome: "2¬™ S√©rie ADM", nivel: "medio", total: "BAP249:BCZ479", intervaloNomes: "BAP249:BAP479",
      bimestres: {
        1: { inicio: "BAP249", fim: "BCZ294" },
        2: { inicio: "BAP308", fim: "BCZ354" },
        3: { inicio: "BAP370", fim: "BCZ416" },
        4: { inicio: "BAP432", fim: "BCZ479" }
      }
    }
  ];
  
  return CACHE.turmasMap;
}

// ============================================
// FUN√á√ïES DE AN√ÅLISE DE DADOS
// ============================================

/**
 * Analisa todas as turmas e calcula rankings
 */
function analisarTodasTurmas() {
  try {
    console.log("üîç Iniciando an√°lise de todas as turmas...");
    
    const turmas = getTurmasMap();
    const resultados = {};
    
    // Para cada s√©rie configurada
    for (const serie in CONFIG_SERIES) {
      console.log(`üìä Processando ${serie}...`);
      
      // Filtrar turmas da s√©rie
      const prefixoSerie = serie.split(' ')[0]; // "6¬∫", "7¬∫", etc.
      const turmasSerie = turmas.filter(t => t.nome.startsWith(prefixoSerie));
      
      if (turmasSerie.length === 0) {
        console.log(`‚ö†Ô∏è Nenhuma turma encontrada para ${serie}`);
        continue;
      }
      
      // Processar todas as turmas da s√©rie
      const dadosSerie = processarSerie(turmasSerie);
      
      if (dadosSerie && dadosSerie.length > 0) {
        resultados[serie] = dadosSerie;
        console.log(`‚úÖ ${serie}: ${dadosSerie.length} alunos processados`);
      }
    }
    
    // Armazenar em cache
    const cacheKey = `ranking_${new Date().getTime()}`;
    CACHE.dadosRanking[cacheKey] = resultados;
    CACHE.timestampCache[cacheKey] = new Date().getTime();
    
    console.log("üéØ An√°lise completa!");
    return resultados;
    
  } catch (error) {
    console.error("‚ùå Erro na an√°lise de turmas:", error);
    throw error;
  }
}

/**
 * Processa uma s√©rie espec√≠fica
 */
function processarSerie(turmasSerie) {
  const dadosConsolidados = [];
  
  try {
    const sheetFonte = getSheetFonte();
    
    for (const turma of turmasSerie) {
      console.log(`   üìö Processando turma: ${turma.nome}`);
      
      // Extrair configura√ß√µes da turma
      const totalRange = turma.total;
      const partes = totalRange.split(":");
      const linhaInicio = extrairNumeroLinha(partes[0]);
      const linhaFim = extrairNumeroLinha(partes[1]);
      const colunaInicio = colunaParaNumero(extrairLetrasColuna(partes[0]));
      const colunaFim = colunaParaNumero(extrairLetrasColuna(partes[1]));
      
      // Calcular dimens√µes
      const numLinhas = linhaFim - linhaInicio + 1;
      const numColunas = colunaFim - colunaInicio + 1;
      
      // Ler todos os dados da turma (otimizado)
      const dadosTurma = sheetFonte.getRange(
        linhaInicio, 
        colunaInicio, 
        numLinhas, 
        numColunas
      ).getValues();
      
      // Processar cada bimestre
      const alunosTurma = processarBimestresTurma(turma, dadosTurma, linhaInicio, colunaInicio);
      
      // Adicionar √† consolida√ß√£o
      dadosConsolidados.push(...alunosTurma);
    }
    
    // Calcular rankings para a s√©rie
    return calcularRankingsSerie(dadosConsolidados);
    
  } catch (error) {
    console.error(`‚ùå Erro ao processar s√©rie:`, error);
    return [];
  }
}

/**
 * Processa bimestres de uma turma
 */
function processarBimestresTurma(turma, dadosTurma, linhaOffset, colunaOffset) {
  const alunos = {};
  
  try {
    // Para cada bimestre (1-4)
    for (let bimestre = 1; bimestre <= 4; bimestre++) {
      const configBimestre = turma.bimestres[bimestre];
      if (!configBimestre) continue;
      
      const linhaInicioBim = extrairNumeroLinha(configBimestre.inicio) - linhaOffset;
      const linhaFimBim = extrairNumeroLinha(configBimestre.fim) - linhaOffset;
      const colunaInicioBim = colunaParaNumero(extrairLetrasColuna(configBimestre.inicio)) - colunaOffset;
      
      // Processar cada aluno no bimestre
      for (let linha = linhaInicioBim; linha <= linhaFimBim; linha++) {
        // Nome do aluno (primeira coluna)
        const nomeAluno = dadosTurma[linha][0];
        if (!nomeAluno || nomeAluno.toString().trim() === "") continue;
        
        // Inicializar aluno se n√£o existir
        if (!alunos[nomeAluno]) {
          alunos[nomeAluno] = {
            nome: nomeAluno.toString().trim(),
            turma: turma.nome,
            notasPorBimestre: { 1: [], 2: [], 3: [], 4: [] },
            medias: {
              bim1: null,
              bim2: null,
              bim3: null,
              bim4: null,
              geral: null,
              conceito5: null
            },
            rankings: {
              geral: null,
              bim3: null,
              bim4: null,
              conceito5: null
            }
          };
        }
        
        // Coletar notas do bimestre (ignorar primeira coluna que √© nome)
        const notasBimestre = [];
        for (let col = colunaInicioBim + 1; col < dadosTurma[linha].length; col++) {
          const valor = dadosTurma[linha][col];
          if (valor !== "" && !isNaN(valor) && valor !== null) {
            notasBimestre.push(parseFloat(valor));
          }
        }
        
        alunos[nomeAluno].notasPorBimestre[bimestre] = notasBimestre;
      }
    }
    
    // Calcular m√©dias para cada aluno
    for (const nomeAluno in alunos) {
      const aluno = alunos[nomeAluno];
      
      // Calcular m√©dia de cada bimestre
      for (let bimestre = 1; bimestre <= 4; bimestre++) {
        const notas = aluno.notasPorBimestre[bimestre];
        if (notas.length > 0) {
          const soma = notas.reduce((acc, nota) => acc + nota, 0);
          aluno.medias[`bim${bimestre}`] = soma / notas.length;
        }
      }
      
      // Calcular m√©dia geral (bimestres 3 e 4)
      const mediaBim3 = aluno.medias.bim3 || 0;
      const mediaBim4 = aluno.medias.bim4 || 0;
      aluno.medias.geral = (mediaBim3 + mediaBim4) / 2;
      
      // Calcular 5¬∫ Conceito (m√©dia de todos os bimestres)
      const mediasBimestres = [];
      for (let bimestre = 1; bimestre <= 4; bimestre++) {
        if (aluno.medias[`bim${bimestre}`]) {
          mediasBimestres.push(aluno.medias[`bim${bimestre}`]);
        }
      }
      if (mediasBimestres.length > 0) {
        aluno.medias.conceito5 = mediasBimestres.reduce((acc, media) => acc + media, 0) / mediasBimestres.length;
      }
    }
    
  } catch (error) {
    console.error(`‚ùå Erro ao processar bimestres da turma ${turma.nome}:`, error);
  }
  
  return Object.values(alunos);
}

/**
 * Calcula rankings para uma s√©rie
 */
function calcularRankingsSerie(alunos) {
  if (!alunos || alunos.length === 0) return [];
  
  try {
    // Ordenar por m√©dia geral (descendente)
    const alunosOrdenados = [...alunos].sort((a, b) => {
      const mediaA = a.medias.geral || 0;
      const mediaB = b.medias.geral || 0;
      return mediaB - mediaA;
    });
    
    // Atribuir rankings
    alunosOrdenados.forEach((aluno, index) => {
      aluno.rankings.geral = index + 1;
    });
    
    // Ordenar por 3¬∫ bimestre
    const alunosBim3 = [...alunos].sort((a, b) => {
      const mediaA = a.medias.bim3 || 0;
      const mediaB = b.medias.bim3 || 0;
      return mediaB - mediaA;
    });
    
    // Atribuir rankings do 3¬∫ bimestre
    alunosBim3.forEach((aluno, index) => {
      const alunoOriginal = alunosOrdenados.find(a => a.nome === aluno.nome);
      if (alunoOriginal) {
        alunoOriginal.rankings.bim3 = index + 1;
      }
    });
    
    // Ordenar por 4¬∫ bimestre
    const alunosBim4 = [...alunos].sort((a, b) => {
      const mediaA = a.medias.bim4 || 0;
      const mediaB = b.medias.bim4 || 0;
      return mediaB - mediaA;
    });
    
    // Atribuir rankings do 4¬∫ bimestre
    alunosBim4.forEach((aluno, index) => {
      const alunoOriginal = alunosOrdenados.find(a => a.nome === aluno.nome);
      if (alunoOriginal) {
        alunoOriginal.rankings.bim4 = index + 1;
      }
    });
    
    // Ordenar por 5¬∫ Conceito
    const alunosConceito5 = [...alunos].sort((a, b) => {
      const mediaA = a.medias.conceito5 || 0;
      const mediaB = b.medias.conceito5 || 0;
      return mediaB - mediaA;
    });
    
    // Atribuir rankings do 5¬∫ Conceito
    alunosConceito5.forEach((aluno, index) => {
      const alunoOriginal = alunosOrdenados.find(a => a.nome === aluno.nome);
      if (alunoOriginal) {
        alunoOriginal.rankings.conceito5 = index + 1;
      }
    });
    
    return alunosOrdenados;
    
  } catch (error) {
    console.error("‚ùå Erro ao calcular rankings:", error);
    return alunos;
  }
}

// ============================================
// FUN√á√ïES DE REGISTRO NO BANCO DE DADOS
// ============================================

/**
 * Registra todas as m√©dias no banco de dados
 */
function registrarMediasBancoDados() {
  try {
    console.log("üíæ Iniciando registro no banco de dados...");
    
    const sheetDestino = getSheetDestino();
    
    // 1. Analisar todas as turmas
    const resultados = analisarTodasTurmas();
    
    if (Object.keys(resultados).length === 0) {
      throw new Error("Nenhum dado encontrado para registro");
    }
    
    // 2. Limpar √°reas de destino
    limparAreasDestino(sheetDestino);
    
    // 3. Registrar dados de cada s√©rie
    for (const serie in CONFIG_SERIES) {
      if (resultados[serie]) {
        registrarSerieNoBanco(sheetDestino, serie, resultados[serie]);
      }
    }
    
    // 4. Atualizar cabe√ßalhos com rankings
    atualizarCabecalhosRanking(sheetDestino, resultados);
    
    // 5. Aplicar formata√ß√£o
    aplicarFormatacaoBancoDados(sheetDestino);
    
    console.log("‚úÖ Registro no banco de dados conclu√≠do!");
    
    return {
      success: true,
      message: "Dados registrados com sucesso!",
      timestamp: new Date().toLocaleString('pt-BR'),
      seriesProcessadas: Object.keys(resultados).length
    };
    
  } catch (error) {
    console.error("‚ùå Erro no registro no banco de dados:", error);
    return {
      success: false,
      error: error.message,
      timestamp: new Date().toLocaleString('pt-BR')
    };
  }
}

/**
 * Limpa as √°reas de destino antes de registrar novos dados
 */
function limparAreasDestino(sheet) {
  try {
    // Para cada s√©rie, limpar o intervalo correspondente
    for (const serie in CONFIG_SERIES) {
      const config = CONFIG_SERIES[serie];
      const inicio = config.nomesAlunos.inicio;
      const fim = config.nomesAlunos.fim;
      
      // Limpar de D at√© J
      sheet.getRange(`D${inicio}:J${fim}`).clearContent();
      sheet.getRange(`D${inicio}:J${fim}`).clearFormat();
    }
    
    console.log("üßπ √Åreas de destino limpas");
  } catch (error) {
    console.error("‚ùå Erro ao limpar √°reas de destino:", error);
  }
}

/**
 * Registra uma s√©rie espec√≠fica no banco de dados
 */
function registrarSerieNoBanco(sheet, serieNome, alunosSerie) {
  try {
    const config = CONFIG_SERIES[serieNome];
    if (!config) {
      console.log(`‚ö†Ô∏è Configura√ß√£o n√£o encontrada para ${serieNome}`);
      return;
    }
    
    // Ordenar alunos por ranking geral e pegar top 20
    const top20Alunos = alunosSerie
      .sort((a, b) => a.rankings.geral - b.rankings.geral)
      .slice(0, 20);
    
    // Preencher dados para cada aluno no top 20
    top20Alunos.forEach((aluno, index) => {
      const linha = config.nomesAlunos.inicio + index;
      
      // Nome do aluno
      sheet.getRange(`D${linha}`).setValue(aluno.nome);
      
      // S√©rie/Turma (formatar)
      const turmaMatch = aluno.turma.match(/(\d+¬∫|\d+¬™)\s*(\w+)/);
      if (turmaMatch) {
        const serieFormatada = turmaMatch[1].includes('¬™') ? 
          `${turmaMatch[1]} ${turmaMatch[2].charAt(0)}` : 
          `${turmaMatch[1]}${turmaMatch[2].charAt(0)}`;
        sheet.getRange(`E${linha}`).setValue(serieFormatada);
      } else {
        sheet.getRange(`E${linha}`).setValue(aluno.turma);
      }
      
      // M√©dia 3¬∫ Bimestre
      const mediaBim3 = aluno.medias.bim3 ? aluno.medias.bim3.toFixed(2) : "0.00";
      sheet.getRange(`H${linha}`).setValue(parseFloat(mediaBim3));
      
      // M√©dia 4¬∫ Bimestre
      const mediaBim4 = aluno.medias.bim4 ? aluno.medias.bim4.toFixed(2) : "0.00";
      sheet.getRange(`I${linha}`).setValue(parseFloat(mediaBim4));
      
      // M√©dia Geral
      const mediaGeral = aluno.medias.geral ? aluno.medias.geral.toFixed(2) : "0.00";
      sheet.getRange(`J${linha}`).setValue(parseFloat(mediaGeral));
      
      // Adicionar notas de rodap√© com rankings
      const rodape = `#${aluno.rankings.geral}¬∫ Geral | #${aluno.rankings.bim3}¬∫ 3¬∫B | #${aluno.rankings.bim4}¬∫ 4¬∫B | #${aluno.rankings.conceito5}¬∫ 5¬∫C`;
      sheet.getRange(`D${linha}`).setNote(rodape);
    });
    
    console.log(`‚úÖ ${serieNome}: ${top20Alunos.length} alunos registrados`);
    
  } catch (error) {
    console.error(`‚ùå Erro ao registrar ${serieNome}:`, error);
  }
}

/**
 * Atualiza cabe√ßalhos com informa√ß√µes de ranking
 */
function atualizarCabecalhosRanking(sheet, resultados) {
  try {
    // Determinar bimestre atual
    const dataAtual = new Date();
    const mes = dataAtual.getMonth() + 1;
    let bimestreAtual = 1;
    
    if (mes >= 2 && mes <= 4) bimestreAtual = 1;
    else if (mes >= 5 && mes <= 7) bimestreAtual = 2;
    else if (mes >= 8 && mes <= 10) bimestreAtual = 3;
    else bimestreAtual = 4;
    
    // Criar cabe√ßalho principal
    let cabecalho = `üèÜ SISTEMA DE RANKING ESCOLAR - TOP 20 ALUNOS\n`;
    cabecalho += `üìÖ Data: ${dataAtual.toLocaleDateString('pt-BR')} ${dataAtual.toLocaleTimeString('pt-BR')}\n`;
    cabecalho += `üìä Bimestre de Refer√™ncia: ${bimestreAtual}¬∫ Bimestre\n`;
    cabecalho += `üéØ 5¬∫ Conceito: M√©dia Anual por Disciplina\n\n`;
    
    // Adicionar TOP 1 de cada s√©rie
    cabecalho += `‚≠ê TOP 1 POR S√âRIE:\n`;
    
    for (const serie in CONFIG_SERIES) {
      if (resultados[serie] && resultados[serie].length > 0) {
        const top1 = resultados[serie][0];
        cabecalho += `‚Ä¢ ${serie}: ${top1.nome} (M√©dia: ${top1.medias.geral ? top1.medias.geral.toFixed(2) : 'N/A'})\n`;
      }
    }
    
    // Adicionar TOP 2 Geral (melhores entre todas as s√©ries)
    cabecalho += `\nü•á TOP 2 GERAL (Melhores M√©dias):\n`;
    
    // Coletar todos os alunos de todas as s√©ries
    const todosAlunos = [];
    for (const serie in resultados) {
      if (resultados[serie]) {
        todosAlunos.push(...resultados[serie].map(aluno => ({
          ...aluno,
          serie: serie
        })));
      }
    }
    
    // Ordenar por m√©dia geral
    const topGeral = todosAlunos
      .sort((a, b) => (b.medias.geral || 0) - (a.medias.geral || 0))
      .slice(0, 2);
    
    topGeral.forEach((aluno, index) => {
      const medalha = index === 0 ? 'ü•á' : 'ü•à';
      cabecalho += `${medalha} ${aluno.nome} - ${aluno.serie} (${aluno.medias.geral ? aluno.medias.geral.toFixed(2) : 'N/A'})\n`;
    });
    
    // Adicionar TOP 3 do 5¬∫ Conceito
    cabecalho += `\nüìö TOP 3 - 5¬∫ CONCEITO (M√©dia Anual):\n`;
    
    // Ordenar por 5¬∫ Conceito
    const topConceito5 = todosAlunos
      .sort((a, b) => (b.medias.conceito5 || 0) - (a.medias.conceito5 || 0))
      .slice(0, 3);
    
    topConceito5.forEach((aluno, index) => {
      const medalha = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
      cabecalho += `${medalha} ${aluno.nome} - ${aluno.serie} (${aluno.medias.conceito5 ? aluno.medias.conceito5.toFixed(2) : 'N/A'})\n`;
    });
    
    // Configurar cabe√ßalho na c√©lula A1
    const celulaCabecalho = sheet.getRange("A1");
    celulaCabecalho.setValue(cabecalho);
    celulaCabecalho.setFontSize(10);
    celulaCabecalho.setFontWeight("bold");
    celulaCabecalho.setWrap(true);
    celulaCabecalho.setVerticalAlignment("top");
    celulaCabecalho.setHorizontalAlignment("left");
    
    // Ajustar largura da coluna A
    sheet.setColumnWidth(1, 400);
    
    // Congelar cabe√ßalho
    sheet.setFrozenRows(2);
    
    console.log("‚úÖ Cabe√ßalhos atualizados com rankings");
    
  } catch (error) {
    console.error("‚ùå Erro ao atualizar cabe√ßalhos:", error);
  }
}

/**
 * Aplica formata√ß√£o condicional ao banco de dados
 */
function aplicarFormatacaoBancoDados(sheet) {
  try {
    // Para cada s√©rie, aplicar formata√ß√£o
    for (const serie in CONFIG_SERIES) {
      const config = CONFIG_SERIES[serie];
      const inicio = config.nomesAlunos.inicio;
      const fim = Math.min(config.nomesAlunos.inicio + 19, config.nomesAlunos.fim);
      
      if (inicio > fim) continue;
      
      // Formata√ß√£o para m√©dias do 3¬∫ bimestre (coluna H)
      const rangeBim3 = sheet.getRange(`H${inicio}:H${fim}`);
      aplicarFormatacaoCondicional(rangeBim3, "H");
      
      // Formata√ß√£o para m√©dias do 4¬∫ bimestre (coluna I)
      const rangeBim4 = sheet.getRange(`I${inicio}:I${fim}`);
      aplicarFormatacaoCondicional(rangeBim4, "I");
      
      // Formata√ß√£o para m√©dias gerais (coluna J)
      const rangeGeral = sheet.getRange(`J${inicio}:J${fim}`);
      aplicarFormatacaoCondicional(rangeGeral, "J");
      
      // Formatar cabe√ßalhos das colunas
      sheet.getRange(`H${inicio-1}`).setValue("3¬∫ Bim").setFontWeight("bold");
      sheet.getRange(`I${inicio-1}`).setValue("4¬∫ Bim").setFontWeight("bold");
      sheet.getRange(`J${inicio-1}`).setValue("M√©dia").setFontWeight("bold");
      
      // Ajustar largura das colunas
      sheet.setColumnWidth(colunaParaNumero("D"), 200); // Nome
      sheet.setColumnWidth(colunaParaNumero("E"), 80);  // S√©rie
      sheet.setColumnWidth(colunaParaNumero("H"), 80);  // 3¬∫ Bim
      sheet.setColumnWidth(colunaParaNumero("I"), 80);  // 4¬∫ Bim
      sheet.setColumnWidth(colunaParaNumero("J"), 80);  // M√©dia
    }
    
    // Adicionar bordas
    const dataRange = sheet.getDataRange();
    dataRange.setBorder(true, true, true, true, true, true);
    
    console.log("‚úÖ Formata√ß√£o aplicada ao banco de dados");
    
  } catch (error) {
    console.error("‚ùå Erro ao aplicar formata√ß√£o:", error);
  }
}

/**
 * Aplica formata√ß√£o condicional a um intervalo
 */
function aplicarFormatacaoCondicional(range, coluna) {
  try {
    const sheet = range.getSheet();
    
    // Remover formata√ß√µes condicionais antigas
    const regras = sheet.getConditionalFormatRules();
    const novasRegras = regras.filter(regra => {
      const ranges = regra.getRanges();
      return !ranges.some(r => r.getA1Notation() === range.getA1Notation());
    });
    
    // Regra para notas altas (>= 8.5) - Verde
    const regraAlta = SpreadsheetApp.newConditionalFormatRule()
      .whenNumberGreaterThanOrEqualTo(8.5)
      .setBackground("#C6EFCE")  // Verde claro
      .setFontColor("#006100")   // Verde escuro
      .setRanges([range])
      .build();
    
    // Regra para notas m√©dias (>= 7 e < 8.5) - Amarelo
    const regraMedia = SpreadsheetApp.newConditionalFormatRule()
      .whenNumberBetween(7, 8.49)
      .setBackground("#FFEB9C")  // Amarelo claro
      .setFontColor("#9C6500")   // Marrom escuro
      .setRanges([range])
      .build();
    
    // Regra para notas baixas (< 7) - Vermelho
    const regraBaixa = SpreadsheetApp.newConditionalFormatRule()
      .whenNumberLessThan(7)
      .setBackground("#FFC7CE")  // Vermelho claro
      .setFontColor("#9C0006")   // Vermelho escuro
      .setRanges([range])
      .build();
    
    novasRegras.push(regraAlta, regraMedia, regraBaixa);
    sheet.setConditionalFormatRules(novasRegras);
    
  } catch (error) {
    console.error(`‚ùå Erro ao aplicar formata√ß√£o condicional na coluna ${coluna}:`, error);
  }
}

// ============================================
// FUN√á√ïES DE CONSULTA E RELAT√ìRIOS
// ============================================

/**
 * Consulta ranking de um aluno espec√≠fico
 */
function consultarRankingAluno(nomeAluno, serie = null) {
  try {
    // Se n√£o tem cache, analisar primeiro
    let cacheKey = Object.keys(CACHE.dadosRanking).find(key => key.startsWith("ranking_"));
    if (!cacheKey) {
      analisarTodasTurmas();
      cacheKey = Object.keys(CACHE.dadosRanking).find(key => key.startsWith("ranking_"));
    }
    
    const resultados = CACHE.dadosRanking[cacheKey];
    if (!resultados) {
      return { encontrado: false, mensagem: "Dados n√£o dispon√≠veis" };
    }
    
    const nomeNormalizado = normalizarTexto(nomeAluno);
    let alunoEncontrado = null;
    let serieAluno = null;
    
    // Buscar aluno em todas as s√©ries ou em s√©rie espec√≠fica
    if (serie) {
      if (resultados[serie]) {
        alunoEncontrado = resultados[serie].find(aluno => 
          normalizarTexto(aluno.nome).includes(nomeNormalizado) || 
          nomeNormalizado.includes(normalizarTexto(aluno.nome))
        );
        if (alunoEncontrado) serieAluno = serie;
      }
    } else {
      for (const serieNome in resultados) {
        if (resultados[serieNome]) {
          alunoEncontrado = resultados[serieNome].find(aluno => 
            normalizarTexto(aluno.nome).includes(nomeNormalizado) || 
            nomeNormalizado.includes(normalizarTexto(aluno.nome))
          );
          if (alunoEncontrado) {
            serieAluno = serieNome;
            break;
          }
        }
      }
    }
    
    if (!alunoEncontrado) {
      return { encontrado: false, mensagem: "Aluno n√£o encontrado" };
    }
    
    // Coletar informa√ß√µes do top 20 da s√©rie do aluno
    const top20Serie = resultados[serieAluno]?.slice(0, 20) || [];
    const posicaoTop20 = top20Serie.findIndex(aluno => aluno.nome === alunoEncontrado.nome);
    const estaNoTop20 = posicaoTop20 !== -1;
    
    // Encontrar TOP 1, TOP 2, TOP 3 da s√©rie
    const top1Serie = resultados[serieAluno]?.[0] || null;
    const top2Serie = resultados[serieAluno]?.[1] || null;
    const top3Serie = resultados[serieAluno]?.[2] || null;
    
    // Encontrar TOP 1 do 5¬∫ Conceito na s√©rie
    const serieAlunos = resultados[serieAluno] || [];
    const top1Conceito5 = [...serieAlunos]
      .sort((a, b) => (b.medias.conceito5 || 0) - (a.medias.conceito5 || 0))
      .shift();
    
    // Determinar classifica√ß√£o
    let classificacao = [];
    if (alunoEncontrado.rankings.geral === 1) {
      classificacao.push("TOP 1 GERAL");
    }
    if (alunoEncontrado.rankings.geral <= 2) {
      classificacao.push("TOP 2 GERAL");
    }
    if (alunoEncontrado.rankings.conceito5 === 1) {
      classificacao.push("TOP 1 - 5¬∫ CONCEITO");
    }
    if (alunoEncontrado.rankings.conceito5 <= 3) {
      classificacao.push("TOP 3 - 5¬∫ CONCEITO");
    }
    if (estaNoTop20) {
      classificacao.push("TOP 20 DA S√âRIE");
    }
    
    return {
      encontrado: true,
      aluno: {
        nome: alunoEncontrado.nome,
        turma: alunoEncontrado.turma,
        serie: serieAluno
      },
      medias: {
        bim3: alunoEncontrado.medias.bim3?.toFixed(2) || "N/A",
        bim4: alunoEncontrado.medias.bim4?.toFixed(2) || "N/A",
        geral: alunoEncontrado.medias.geral?.toFixed(2) || "N/A",
        conceito5: alunoEncontrado.medias.conceito5?.toFixed(2) || "N/A"
      },
      rankings: {
        geral: alunoEncontrado.rankings.geral,
        bim3: alunoEncontrado.rankings.bim3,
        bim4: alunoEncontrado.rankings.bim4,
        conceito5: alunoEncontrado.rankings.conceito5,
        noTop20: estaNoTop20 ? posicaoTop20 + 1 : null
      },
      classificacao: classificacao,
      comparativo: {
        top1Geral: top1Serie ? { nome: top1Serie.nome, media: top1Serie.medias.geral?.toFixed(2) } : null,
        top2Geral: top2Serie ? { nome: top2Serie.nome, media: top2Serie.medias.geral?.toFixed(2) } : null,
        top3Geral: top3Serie ? { nome: top3Serie.nome, media: top3Serie.medias.geral?.toFixed(2) } : null,
        top1Conceito5: top1Conceito5 ? { nome: top1Conceito5.nome, media: top1Conceito5.medias.conceito5?.toFixed(2) } : null
      },
      mensagem: classificacao.length > 0 ? 
        `üéâ ${classificacao.join(" | ")} üéâ` : 
        `üìä Posi√ß√£o: ${alunoEncontrado.rankings.geral}¬∫ na s√©rie`
    };
    
  } catch (error) {
    console.error("‚ùå Erro na consulta de ranking:", error);
    return { encontrado: false, erro: error.message };
  }
}

/**
 * Gera relat√≥rio completo de ranking
 */
function gerarRelatorioCompleto() {
  try {
    const cacheKey = Object.keys(CACHE.dadosRanking).find(key => key.startsWith("ranking_"));
    if (!cacheKey) {
      analisarTodasTurmas();
    }
    
    const resultados = CACHE.dadosRanking[cacheKey] || analisarTodasTurmas();
    
    const relatorio = {
      titulo: "üìä RELAT√ìRIO COMPLETO DE RANKING ESCOLAR",
      data: new Date().toLocaleString('pt-BR'),
      series: {},
      totais: {
        totalAlunos: 0,
        totalSeries: 0
      }
    };
    
    for (const serie in CONFIG_SERIES) {
      if (resultados[serie]) {
        const alunosSerie = resultados[serie];
        const top20 = alunosSerie.slice(0, 20);
        
        relatorio.series[serie] = {
          totalAlunos: alunosSerie.length,
          top1: top20[0] ? {
            nome: top20[0].nome,
            mediaGeral: top20[0].medias.geral?.toFixed(2),
            turma: top20[0].turma
          } : null,
          top20: top20.map((aluno, index) => ({
            posicao: index + 1,
            nome: aluno.nome,
            mediaGeral: aluno.medias.geral?.toFixed(2),
            mediaBim3: aluno.medias.bim3?.toFixed(2),
            mediaBim4: aluno.medias.bim4?.toFixed(2),
            mediaConceito5: aluno.medias.conceito5?.toFixed(2),
            turma: aluno.turma
          }))
        };
        
        relatorio.totais.totalAlunos += alunosSerie.length;
        relatorio.totais.totalSeries++;
      }
    }
    
    return relatorio;
    
  } catch (error) {
    console.error("‚ùå Erro ao gerar relat√≥rio:", error);
    return { erro: error.message };
  }
}

// ============================================
// FUN√á√ïES DE INTERFACE E MENU
// ============================================

/**
 * Cria menu personalizado na planilha
 */
function criarMenu() {
  try {
    const ui = SpreadsheetApp.getUi();
    
    ui.createMenu('üèÜ SISTEMA DE RANKING')
      .addItem('üìä Calcular e Atualizar Ranking', 'executarAtualizacaoRanking')
      .addSeparator()
      .addSubMenu(ui.createMenu('üîç Consultas')
        .addItem('Buscar Aluno no Ranking', 'abrirDialogoBuscaAluno')
        .addItem('Ver Top 20 por S√©rie', 'abrirDialogoTop20')
        .addItem('Relat√≥rio Completo', 'abrirRelatorioCompleto')
      )
      .addSeparator()
      .addItem('üîÑ For√ßar Atualiza√ß√£o de Dados', 'forcarAtualizacaoDados')
      .addItem('‚öôÔ∏è Configurar Sistema', 'abrirConfiguracoes')
      .addToUi();
    
    console.log("‚úÖ Menu criado com sucesso");
  } catch (error) {
    console.error("‚ùå Erro ao criar menu:", error);
  }
}

/**
 * Executa atualiza√ß√£o completa do ranking
 */
function executarAtualizacaoRanking() {
  try {
    const ui = SpreadsheetApp.getUi();
    
    // Mostrar di√°logo de confirma√ß√£o
    const resposta = ui.alert(
      'üîÑ Atualizar Ranking',
      'Deseja calcular e atualizar o ranking completo?\n\nEsta opera√ß√£o pode levar alguns minutos.',
      ui.ButtonSet.YES_NO
    );
    
    if (resposta !== ui.Button.YES) {
      return;
    }
    
    // Mostrar di√°logo de progresso
    const html = HtmlService.createHtmlOutput(`
      <div style="padding: 20px; font-family: Arial, sans-serif; text-align: center;">
        <h2>üîÑ Processando Ranking</h2>
        <p>Analisando dados e calculando rankings...</p>
        <div id="progress" style="margin: 20px 0;">
          <div style="background: #f0f0f0; height: 20px; border-radius: 10px; overflow: hidden;">
            <div id="progressBar" style="background: #4CAF50; height: 100%; width: 0%; transition: width 0.3s;"></div>
          </div>
        </div>
        <p id="status">Iniciando an√°lise...</p>
      </div>
      <script>
        // Atualizar progresso
        let progresso = 0;
        function atualizarProgresso(mensagem, incremento) {
          progresso = Math.min(progresso + incremento, 100);
          document.getElementById('progressBar').style.width = progresso + '%';
          document.getElementById('status').innerText = mensagem;
          
          if (progresso >= 100) {
            google.script.run
              .withSuccessHandler(function() {
                google.script.host.close();
              })
              .finalizarAtualizacao();
          }
        }
        
        // Simular progresso
        setTimeout(() => atualizarProgresso('Analisando turmas...', 20), 500);
        setTimeout(() => atualizarProgresso('Calculando m√©dias...', 30), 1500);
        setTimeout(() => atualizarProgresso('Gerando rankings...', 30), 3000);
        setTimeout(() => atualizarProgresso('Registrando no banco de dados...', 20), 4500);
      </script>
    `).setWidth(400).setHeight(200);
    
    ui.showModalDialog(html, 'Processando...');
    
    // Executar em background
    const resultado = registrarMediasBancoDados();
    
    // Fechar di√°logo e mostrar resultado
    ui.alert(
      resultado.success ? '‚úÖ Atualiza√ß√£o Conclu√≠da' : '‚ùå Erro na Atualiza√ß√£o',
      resultado.success ? 
        `Ranking atualizado com sucesso!\n\n` +
        `S√©ries processadas: ${resultado.seriesProcessadas}\n` +
        `Data: ${resultado.timestamp}` :
        `Erro: ${resultado.error}\n\n` +
        `Data: ${resultado.timestamp}`,
      ui.ButtonSet.OK
    );
    
  } catch (error) {
    const ui = SpreadsheetApp.getUi();
    ui.alert('‚ùå Erro', `Ocorreu um erro:\n\n${error.message}`, ui.ButtonSet.OK);
  }
}

/**
 * Finaliza a atualiza√ß√£o (chamada pelo di√°logo)
 */
function finalizarAtualizacao() {
  return true;
}

/**
 * Abre di√°logo para busca de aluno
 */
function abrirDialogoBuscaAluno() {
  try {
    const html = HtmlService.createHtmlOutput(`
      <!DOCTYPE html>
      <html>
      <head>
        <base target="_top">
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          .container { max-width: 500px; margin: 0 auto; }
          .input-group { margin-bottom: 15px; }
          label { display: block; margin-bottom: 5px; font-weight: bold; }
          input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
          button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
          button:hover { background: #45a049; }
          .resultado { margin-top: 20px; padding: 15px; border-radius: 5px; }
          .sucesso { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
          .erro { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
          .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
          .ranking-badge { 
            display: inline-block; 
            padding: 3px 8px; 
            margin: 2px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: bold; 
          }
          .top1 { background: #FFD700; }
          .top2 { background: #C0C0C0; }
          .top3 { background: #CD7F32; }
          .top20 { background: #4CAF50; color: white; }
        </style>
      </head>
      <body>
        <div class="container">
          <h2>üîç Buscar Aluno no Ranking</h2>
          
          <div class="input-group">
            <label for="nomeAluno">Nome do Aluno:</label>
            <input type="text" id="nomeAluno" placeholder="Digite o nome completo ou parcial">
          </div>
          
          <div class="input-group">
            <label for="serie">S√©rie (opcional):</label>
            <select id="serie">
              <option value="">Todas as s√©ries</option>
              <option value="6¬∫ Ano">6¬∫ Ano</option>
              <option value="7¬∫ Ano">7¬∫ Ano</option>
              <option value="8¬∫ Ano">8¬∫ Ano</option>
              <option value="9¬∫ Ano">9¬∫ Ano</option>
              <option value="1¬™ S√©rie">1¬™ S√©rie</option>
              <option value="2¬™ S√©rie">2¬™ S√©rie</option>
              <option value="3¬™ S√©rie">3¬™ S√©rie</option>
            </select>
          </div>
          
          <button onclick="buscarAluno()">Buscar</button>
          
          <div id="resultado" class="resultado" style="display: none;"></div>
        </div>
        
        <script>
          function buscarAluno() {
            const nome = document.getElementById('nomeAluno').value.trim();
            const serie = document.getElementById('serie').value;
            
            if (!nome) {
              mostrarResultado('Por favor, digite um nome para buscar.', 'erro');
              return;
            }
            
            google.script.run
              .withSuccessHandler(exibirResultado)
              .withFailureHandler(mostrarErro)
              .consultarRankingAluno(nome, serie);
          }
          
          function exibirResultado(dados) {
            const div = document.getElementById('resultado');
            
            if (!dados.encontrado) {
              mostrarResultado(dados.mensagem || 'Aluno n√£o encontrado.', 'erro');
              return;
            }
            
            let html = \`
              <div class="sucesso">
                <h3>üéì \${dados.aluno.nome}</h3>
                <p><strong>S√©rie/Turma:</strong> \${dados.aluno.serie} - \${dados.aluno.turma}</p>
                
                <h4>üìä Classifica√ß√£o:</h4>
                <div>\${dados.classificacao.map(c => \`<span class="ranking-badge \${c.toLowerCase().replace(/[^a-z]/g, '')}">\${c}</span>\`).join(' ')}</div>
                
                <h4>üìà M√©dias:</h4>
                <p><strong>3¬∫ Bimestre:</strong> \${dados.medias.bim3}</p>
                <p><strong>4¬∫ Bimestre:</strong> \${dados.medias.bim4}</p>
                <p><strong>M√©dia Geral:</strong> \${dados.medias.geral}</p>
                <p><strong>5¬∫ Conceito:</strong> \${dados.medias.conceito5}</p>
                
                <h4>üèÜ Rankings:</h4>
                <p><strong>Geral:</strong> \${dados.rankings.geral}¬∫ lugar</p>
                <p><strong>3¬∫ Bimestre:</strong> \${dados.rankings.bim3}¬∫ lugar</p>
                <p><strong>4¬∫ Bimestre:</strong> \${dados.rankings.bim4}¬∫ lugar</p>
                <p><strong>5¬∫ Conceito:</strong> \${dados.rankings.conceito5}¬∫ lugar</p>
                \${dados.rankings.noTop20 ? \`<p><strong>Top 20 da S√©rie:</strong> \${dados.rankings.noTop20}¬∫ lugar</p>\` : ''}
                
                <h4>‚≠ê Comparativo:</h4>
                \${dados.comparativo.top1Geral ? \`<p><strong>Top 1 Geral:</strong> \${dados.comparativo.top1Geral.nome} (\${dados.comparativo.top1Geral.media})</p>\` : ''}
                \${dados.comparativo.top1Conceito5 ? \`<p><strong>Top 1 - 5¬∫ Conceito:</strong> \${dados.comparativo.top1Conceito5.nome} (\${dados.comparativo.top1Conceito5.media})</p>\` : ''}
                
                <p style="margin-top: 15px; font-weight: bold; color: #155724;">\${dados.mensagem}</p>
              </div>
            \`;
            
            div.innerHTML = html;
            div.style.display = 'block';
          }
          
          function mostrarResultado(mensagem, tipo) {
            const div = document.getElementById('resultado');
            div.innerHTML = \`<div class="\${tipo}">\${mensagem}</div>\`;
            div.style.display = 'block';
          }
          
          function mostrarErro(erro) {
            mostrarResultado('Erro: ' + erro, 'erro');
          }
        </script>
      </body>
      </html>
    `).setWidth(600).setHeight(700);
    
    SpreadsheetApp.getUi().showModalDialog(html, 'üîç Buscar Aluno');
    
  } catch (error) {
    console.error("‚ùå Erro ao abrir di√°logo de busca:", error);
  }
}

/**
 * Abre di√°logo com Top 20 por s√©rie
 */
function abrirDialogoTop20() {
  try {
    const html = HtmlService.createHtmlOutput(`
      <!DOCTYPE html>
      <html>
      <head>
        <base target="_top">
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          .container { max-width: 800px; margin: 0 auto; }
          select, button { padding: 8px; margin: 5px; }
          .tabela-container { margin-top: 20px; overflow-x: auto; }
          table { width: 100%; border-collapse: collapse; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background: #4CAF50; color: white; }
          tr:nth-child(even) { background: #f2f2f2; }
          .top1 { background: #FFD700 !important; }
          .top2 { background: #C0C0C0 !important; }
          .top3 { background: #CD7F32 !important; }
          .medalha { font-size: 18px; }
        </style>
      </head>
      <body>
        <div class="container">
          <h2>üèÜ Top 20 por S√©rie</h2>
          
          <div>
            <label for="serieSelect">Selecione a s√©rie:</label>
            <select id="serieSelect" onchange="carregarTop20()">
              <option value="">Selecione...</option>
              <option value="6¬∫ Ano">6¬∫ Ano</option>
              <option value="7¬∫ Ano">7¬∫ Ano</option>
              <option value="8¬∫ Ano">8¬∫ Ano</option>
              <option value="9¬∫ Ano">9¬∫ Ano</option>
              <option value="1¬™ S√©rie">1¬™ S√©rie</option>
              <option value="2¬™ S√©rie">2¬™ S√©rie</option>
              <option value="3¬™ S√©rie">3¬™ S√©rie</option>
            </select>
          </div>
          
          <div id="tabelaContainer" class="tabela-container" style="display: none;">
            <h3 id="tituloSerie"></h3>
            <table id="tabelaTop20">
              <thead>
                <tr>
                  <th>Posi√ß√£o</th>
                  <th>Nome</th>
                  <th>Turma</th>
                  <th>M√©dia Geral</th>
                  <th>3¬∫ Bim</th>
                  <th>4¬∫ Bim</th>
                  <th>5¬∫ Conceito</th>
                </tr>
              </thead>
              <tbody id="corpoTabela"></tbody>
            </table>
          </div>
          
          <div id="mensagem" style="margin-top: 20px; display: none;"></div>
        </div>
        
        <script>
          function carregarTop20() {
            const serie = document.getElementById('serieSelect').value;
            if (!serie) return;
            
            google.script.run
              .withSuccessHandler(exibirTop20)
              .withFailureHandler(mostrarErro)
              .obterTop20Serie(serie);
          }
          
          function exibirTop20(dados) {
            const container = document.getElementById('tabelaContainer');
            const titulo = document.getElementById('tituloSerie');
            const corpo = document.getElementById('corpoTabela');
            const mensagemDiv = document.getElementById('mensagem');
            
            if (!dados || dados.erro) {
              container.style.display = 'none';
              mensagemDiv.innerHTML = '<p style="color: red;">' + (dados.erro || 'Erro ao carregar dados') + '</p>';
              mensagemDiv.style.display = 'block';
              return;
            }
            
            titulo.textContent = \`Top 20 - \${dados.serie}\`;
            
            let html = '';
            dados.top20.forEach((aluno, index) => {
              const medalha = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : \`\${index + 1}¬∫\`;
              const classeLinha = index === 0 ? 'top1' : index === 1 ? 'top2' : index === 2 ? 'top3' : '';
              
              html += \`
                <tr class="\${classeLinha}">
                  <td><span class="medalha">\${medalha}</span></td>
                  <td>\${aluno.nome}</td>
                  <td>\${aluno.turma}</td>
                  <td>\${aluno.mediaGeral}</td>
                  <td>\${aluno.mediaBim3}</td>
                  <td>\${aluno.mediaBim4}</td>
                  <td>\${aluno.mediaConceito5}</td>
                </tr>
              \`;
            });
            
            corpo.innerHTML = html;
            container.style.display = 'block';
            mensagemDiv.style.display = 'none';
          }
          
          function mostrarErro(erro) {
            const mensagemDiv = document.getElementById('mensagem');
            mensagemDiv.innerHTML = '<p style="color: red;">Erro: ' + erro + '</p>';
            mensagemDiv.style.display = 'block';
          }
        </script>
      </body>
      </html>
    `).setWidth(850).setHeight(600);
    
    SpreadsheetApp.getUi().showModalDialog(html, 'üèÜ Top 20 por S√©rie');
    
  } catch (error) {
    console.error("‚ùå Erro ao abrir di√°logo Top 20:", error);
  }
}

/**
 * Obt√©m Top 20 de uma s√©rie espec√≠fica
 */
function obterTop20Serie(serieNome) {
  try {
    const cacheKey = Object.keys(CACHE.dadosRanking).find(key => key.startsWith("ranking_"));
    if (!cacheKey) {
      analisarTodasTurmas();
    }
    
    const resultados = CACHE.dadosRanking[cacheKey];
    if (!resultados || !resultados[serieNome]) {
      return { erro: "Dados n√£o dispon√≠veis para esta s√©rie" };
    }
    
    const top20 = resultados[serieNome].slice(0, 20).map((aluno, index) => ({
      posicao: index + 1,
      nome: aluno.nome,
      turma: aluno.turma,
      mediaGeral: aluno.medias.geral?.toFixed(2) || "0.00",
      mediaBim3: aluno.medias.bim3?.toFixed(2) || "0.00",
      mediaBim4: aluno.medias.bim4?.toFixed(2) || "0.00",
      mediaConceito5: aluno.medias.conceito5?.toFixed(2) || "0.00"
    }));
    
    return {
      serie: serieNome,
      totalAlunos: resultados[serieNome].length,
      top20: top20
    };
    
  } catch (error) {
    console.error("‚ùå Erro ao obter Top 20:", error);
    return { erro: error.message };
  }
}

/**
 * Abre relat√≥rio completo
 */
function abrirRelatorioCompleto() {
  try {
    const relatorio = gerarRelatorioCompleto();
    
    let html = `
      <!DOCTYPE html>
      <html>
      <head>
        <base target="_top">
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
          .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
          h1, h2, h3 { color: #333; }
          .serie-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
          .top1 { background: #FFF3CD; border-color: #FFEAA7; }
          table { width: 100%; border-collapse: collapse; margin: 10px 0; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background: #4CAF50; color: white; }
          .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin: 2px; }
          .badge-top1 { background: #FFD700; }
          .badge-top2 { background: #C0C0C0; }
          .badge-top3 { background: #CD7F32; }
          .stats { display: flex; justify-content: space-around; margin: 20px 0; }
          .stat-box { text-align: center; padding: 15px; border-radius: 5px; }
          .stat-box.total { background: #E3F2FD; }
          .stat-box.series { background: #E8F5E9; }
          .stat-box.alunos { background: #FFF3E0; }
          .stat-value { font-size: 24px; font-weight: bold; }
          .stat-label { font-size: 14px; color: #666; }
          .export-buttons { margin: 20px 0; }
          button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
          button:hover { background: #45a049; }
          button.export { background: #2196F3; }
          button.export:hover { background: #0b7dda; }
        </style>
      </head>
      <body>
        <div class="container">
          <h1>${relatorio.titulo}</h1>
          <p><strong>Data:</strong> ${relatorio.data}</p>
          
          <div class="stats">
            <div class="stat-box total">
              <div class="stat-value">${relatorio.totais.totalSeries}</div>
              <div class="stat-label">S√©ries Processadas</div>
            </div>
            <div class="stat-box series">
              <div class="stat-value">${relatorio.totais.totalAlunos}</div>
              <div class="stat-label">Total de Alunos</div>
            </div>
          </div>
          
          <div class="export-buttons">
            <button onclick="exportarPDF()">üìÑ Exportar PDF</button>
            <button onclick="exportarPlanilha()">üìä Exportar para Planilha</button>
            <button onclick="imprimir()">üñ®Ô∏è Imprimir Relat√≥rio</button>
          </div>
    `;
    
    for (const serie in relatorio.series) {
      const dadosSerie = relatorio.series[serie];
      
      html += `
        <div class="serie-section ${serie.includes('1') ? 'top1' : ''}">
          <h2>${serie} - Top 20</h2>
          <p><strong>Total de alunos na s√©rie:</strong> ${dadosSerie.totalAlunos}</p>
          
          ${dadosSerie.top1 ? `
            <div style="background: #FFF3CD; padding: 10px; border-radius: 5px; margin: 10px 0;">
              <h3>ü•á TOP 1: ${dadosSerie.top1.nome}</h3>
              <p><strong>Turma:</strong> ${dadosSerie.top1.turma} | 
                 <strong>M√©dia Geral:</strong> ${dadosSerie.top1.mediaGeral}</p>
            </div>
          ` : ''}
          
          <table>
            <thead>
              <tr>
                <th>Posi√ß√£o</th>
                <th>Nome</th>
                <th>Turma</th>
                <th>M√©dia Geral</th>
                <th>3¬∫ Bim</th>
                <th>4¬∫ Bim</th>
                <th>5¬∫ Conceito</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      dadosSerie.top20.forEach((aluno, index) => {
        const medalha = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∫`;
        
        html += `
          <tr>
            <td><strong>${medalha}</strong></td>
            <td>${aluno.nome}</td>
            <td>${aluno.turma}</td>
            <td>${aluno.mediaGeral}</td>
            <td>${aluno.mediaBim3}</td>
            <td>${aluno.mediaBim4}</td>
            <td>${aluno.mediaConceito5}</td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
    }
    
    html += `
          <script>
            function exportarPDF() {
              google.script.run.exportarRelatorioPDF();
            }
            
            function exportarPlanilha() {
              google.script.run.exportarParaPlanilha();
            }
            
            function imprimir() {
              window.print();
            }
          </script>
        </div>
      </body>
      </html>
    `;
    
    const dialog = HtmlService.createHtmlOutput(html)
      .setWidth(1000)
      .setHeight(700);
    
    SpreadsheetApp.getUi().showModalDialog(dialog, 'üìä Relat√≥rio Completo');
    
  } catch (error) {
    console.error("‚ùå Erro ao abrir relat√≥rio:", error);
  }
}

/**
 * Abre configura√ß√µes do sistema
 */
function abrirConfiguracoes() {
  try {
    const html = HtmlService.createHtmlOutput(`
      <!DOCTYPE html>
      <html>
      <head>
        <base target="_top">
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          .container { max-width: 600px; margin: 0 auto; }
          .config-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
          label { display: block; margin: 10px 0 5px; }
          input, select { width: 100%; padding: 8px; margin-bottom: 10px; }
          button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
          button:hover { background: #45a049; }
          .danger { background: #f44336; }
          .danger:hover { background: #d32f2f; }
          .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
          .success { background: #d4edda; color: #155724; }
          .error { background: #f8d7da; color: #721c24; }
        </style>
      </head>
      <body>
        <div class="container">
          <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
          
          <div class="config-section">
            <h3>üîÑ Atualiza√ß√£o Autom√°tica</h3>
            <label>
              <input type="checkbox" id="autoUpdate" checked>
              Atualizar automaticamente uma vez por dia
            </label>
            <label>Hora da atualiza√ß√£o:</label>
            <select id="updateHour">
              ${Array.from({length: 24}, (_, i) => `<option value="${i}" ${i === 6 ? 'selected' : ''}>${i.toString().padStart(2, '0')}:00</option>`).join('')}
            </select>
          </div>
          
          <div class="config-section">
            <h3>üíæ Cache</h3>
            <p>Dura√ß√£o do cache: <strong>5 minutos</strong></p>
            <button onclick="limparCache()">üîÑ Limpar Cache</button>
            <button onclick="atualizarCache()">üì• Atualizar Cache Agora</button>
          </div>
          
          <div class="config-section">
            <h3>‚ö†Ô∏è A√ß√µes de Risco</h3>
            <button onclick="resetarSistema()" class="danger">üîÑ Reiniciar Sistema</button>
            <button onclick="testarConexao()" class="danger">üîó Testar Conex√µes</button>
          </div>
          
          <div id="status" class="status" style="display: none;"></div>
        </div>
        
        <script>
          function mostrarStatus(mensagem, tipo) {
            const div = document.getElementById('status');
            div.textContent = mensagem;
            div.className = 'status ' + tipo;
            div.style.display = 'block';
            
            setTimeout(() => {
              div.style.display = 'none';
            }, 5000);
          }
          
          function limparCache() {
            google.script.run
              .withSuccessHandler(() => mostrarStatus('Cache limpo com sucesso!', 'success'))
              .withFailureHandler(erro => mostrarStatus('Erro: ' + erro, 'error'))
              .limparCacheSistema();
          }
          
          function atualizarCache() {
            google.script.run
              .withSuccessHandler(() => mostrarStatus('Cache atualizado com sucesso!', 'success'))
              .withFailureHandler(erro => mostrarStatus('Erro: ' + erro, 'error'))
              .forcarAtualizacaoDados();
          }
          
          function resetarSistema() {
            if (confirm('Tem certeza que deseja reiniciar o sistema? Todas as configura√ß√µes ser√£o redefinidas.')) {
              google.script.run
                .withSuccessHandler(() => mostrarStatus('Sistema reiniciado com sucesso!', 'success'))
                .withFailureHandler(erro => mostrarStatus('Erro: ' + erro, 'error'))
                .reiniciarSistema();
            }
          }
          
          function testarConexao() {
            google.script.run
              .withSuccessHandler(dados => mostrarStatus('Conex√µes testadas com sucesso!', 'success'))
              .withFailureHandler(erro => mostrarStatus('Erro: ' + erro, 'error'))
              .testarConexoes();
          }
        </script>
      </body>
      </html>
    `).setWidth(650).setHeight(500);
    
    SpreadsheetApp.getUi().showModalDialog(html, '‚öôÔ∏è Configura√ß√µes');
    
  } catch (error) {
    console.error("‚ùå Erro ao abrir configura√ß√µes:", error);
  }
}

// ============================================
// FUN√á√ïES DE MANUTEN√á√ÉO E UTILIT√ÅRIOS
// ============================================

/**
 * For√ßa atualiza√ß√£o dos dados
 */
function forcarAtualizacaoDados() {
  try {
    // Limpar cache
    limparCacheCompleto();
    
    // Analisar turmas
    analisarTodasTurmas();
    
    return { success: true, message: "Dados atualizados com sucesso" };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

/**
 * Limpa cache completo
 */
function limparCacheCompleto() {
  CACHE.sheetFonte = null;
  CACHE.sheetDestino = null;
  CACHE.turmasMap = null;
  CACHE.dadosRanking = {};
  CACHE.timestampCache = {};
  
  console.log("üóëÔ∏è Cache limpo completamente");
}

/**
 * Limpa cache do sistema (para interface)
 */
function limparCacheSistema() {
  limparCacheCompleto();
  return "Cache limpo com sucesso!";
}

/**
 * Testa conex√µes com as planilhas
 */
function testarConexoes() {
  try {
    const teste = {
      fonte: { conectada: false, nomeAba: null },
      destino: { conectada: false, nomeAba: null },
      timestamp: new Date().toLocaleString('pt-BR')
    };
    
    // Testar planilha fonte
    try {
      const ssFonte = SpreadsheetApp.openById(PLANILHA_FONTE_ID);
      const sheetFonte = ssFonte.getSheetByName(ABA_FONTE);
      if (sheetFonte) {
        teste.fonte.conectada = true;
        teste.fonte.nomeAba = ABA_FONTE;
      }
    } catch (e) {
      teste.fonte.erro = e.message;
    }
    
    // Testar planilha destino
    try {
      const ssDestino = SpreadsheetApp.openById(PLANILHA_DESTINO_ID);
      const sheetDestino = ssDestino.getSheetByName(ABA_DESTINO);
      if (sheetDestino) {
        teste.destino.conectada = true;
        teste.destino.nomeAba = ABA_DESTINO;
      }
    } catch (e) {
      teste.destino.erro = e.message;
    }
    
    return teste;
  } catch (error) {
    return { erro: error.message };
  }
}

/**
 * Reinicia o sistema
 */
function reiniciarSistema() {
  try {
    // Limpar tudo
    limparCacheCompleto();
    
    // Reconfigurar triggers
    configurarTriggers();
    
    // Recriar menu
    criarMenu();
    
    return "Sistema reiniciado com sucesso!";
  } catch (error) {
    throw new Error("Erro ao reiniciar sistema: " + error.message);
  }
}

// ============================================
// CONFIGURA√á√ÉO DE TRIGGERS
// ============================================

/**
 * Configura triggers autom√°ticos
 */
function configurarTriggers() {
  try {
    // Remover triggers existentes
    const triggers = ScriptApp.getProjectTriggers();
    triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
    
    // Trigger de abertura da planilha (para menu)
    ScriptApp.newTrigger('onOpen')
      .forSpreadsheet(SpreadsheetApp.openById(PLANILHA_FONTE_ID))
      .onOpen()
      .create();
    
    // Trigger de atualiza√ß√£o autom√°tica (di√°ria √†s 6h)
    ScriptApp.newTrigger('executarAtualizacaoAutomatica')
      .timeBased()
      .everyDays(1)
      .atHour(6)
      .create();
    
    console.log("‚úÖ Triggers configurados com sucesso");
  } catch (error) {
    console.error("‚ùå Erro ao configurar triggers:", error);
  }
}

/**
 * Executa atualiza√ß√£o autom√°tica
 */
function executarAtualizacaoAutomatica() {
  try {
    console.log("‚è∞ Executando atualiza√ß√£o autom√°tica...");
    
    const resultado = registrarMediasBancoDados();
    
    if (resultado.success) {
      console.log("‚úÖ Atualiza√ß√£o autom√°tica conclu√≠da com sucesso");
      
      // Enviar email de notifica√ß√£o (opcional)
      enviarEmailNotificacao(resultado);
    } else {
      console.error("‚ùå Erro na atualiza√ß√£o autom√°tica:", resultado.error);
    }
  } catch (error) {
    console.error("‚ùå Erro na execu√ß√£o autom√°tica:", error);
  }
}

/**
 * Envia email de notifica√ß√£o (opcional)
 */
function enviarEmailNotificacao(resultado) {
  try {
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    const assunto = `üìä Ranking Atualizado - ${dataAtual}`;
    
    let corpo = `
      <h2>‚úÖ Ranking Atualizado com Sucesso!</h2>
      <p>O sistema de ranking foi atualizado automaticamente.</p>
      <p><strong>Data:</strong> ${resultado.timestamp}</p>
      <p><strong>S√©ries processadas:</strong> ${resultado.seriesProcessadas || 'N/A'}</p>
      <p><strong>Status:</strong> ${resultado.message}</p>
      <br>
      <p><em>Esta √© uma mensagem autom√°tica do Sistema de Ranking Escolar.</em></p>
    `;
    
    // Enviar para administrador (substituir pelo email desejado)
    const emailAdmin = Session.getActiveUser().getEmail();
    
    if (emailAdmin) {
      MailApp.sendEmail({
        to: emailAdmin,
        subject: assunto,
        htmlBody: corpo
      });
      
      console.log("üìß Email de notifica√ß√£o enviado");
    }
  } catch (error) {
    console.error("‚ùå Erro ao enviar email:", error);
  }
}

// ============================================
// FUN√á√ÉO ONOPEN (ENTRY POINT)
// ============================================

/**
 * Fun√ß√£o executada ao abrir a planilha
 */
function onOpen() {
  try {
    criarMenu();
    console.log("‚úÖ Sistema carregado com sucesso");
  } catch (error) {
    console.error("‚ùå Erro no onOpen:", error);
  }
}

// ============================================
// FUN√á√ïES DE EXPORTA√á√ÉO
// ============================================

/**
 * Exporta relat√≥rio para PDF
 */
function exportarRelatorioPDF() {
  try {
    const relatorio = gerarRelatorioCompleto();
    const dataAtual = new Date().toLocaleDateString('pt-BR');
    
    // Criar novo documento
    const doc = DocumentApp.create(`Relat√≥rio Ranking - ${dataAtual}`);
    const body = doc.getBody();
    
    // Adicionar cabe√ßalho
    body.appendParagraph('RELAT√ìRIO DE RANKING ESCOLAR - TOP 20 ALUNOS')
      .setHeading(DocumentApp.ParagraphHeading.TITLE)
      .setAlignment(DocumentApp.HorizontalAlignment.CENTER);
    
    body.appendParagraph(`Data: ${dataAtual}`)
      .setAlignment(DocumentApp.HorizontalAlignment.CENTER);
    
    body.appendParagraph('');
    
    // Adicionar dados de cada s√©rie
    for (const serie in relatorio.series) {
      const dadosSerie = relatorio.series[serie];
      
      body.appendParagraph(`${serie} - Top 20`)
        .setHeading(DocumentApp.ParagraphHeading.HEADING2);
      
      // Tabela
      const tabela = body.appendTable();
      const cabecalho = tabela.appendTableRow();
      
      ['Posi√ß√£o', 'Nome', 'Turma', 'M√©dia Geral', '3¬∫ Bim', '4¬∫ Bim', '5¬∫ Conceito'].forEach(texto => {
        cabecalho.appendTableCell(texto).setBackgroundColor('#4CAF50').setForegroundColor('#FFFFFF');
      });
      
      // Dados
      dadosSerie.top20.forEach((aluno, index) => {
        const linha = tabela.appendTableRow();
        const medalha = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∫`;
        
        [medalha, aluno.nome, aluno.turma, aluno.mediaGeral, aluno.mediaBim3, aluno.mediaBim4, aluno.mediaConceito5]
          .forEach(texto => linha.appendTableCell(texto.toString()));
      });
      
      body.appendParagraph('');
    }
    
    doc.saveAndClose();
    
    // Mostrar URL do documento
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      '‚úÖ Relat√≥rio Exportado',
      `Relat√≥rio criado com sucesso!\n\nAcesse: ${doc.getUrl()}`,
      ui.ButtonSet.OK
    );
    
  } catch (error) {
    console.error("‚ùå Erro ao exportar PDF:", error);
  }
}

/**
 * Exporta para nova planilha
 */
function exportarParaPlanilha() {
  try {
    const relatorio = gerarRelatorioCompleto();
    const dataAtual = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
    
    // Criar nova planilha
    const novaPlanilha = SpreadsheetApp.create(`Ranking Exportado - ${dataAtual}`);
    const sheet = novaPlanilha.getSheets()[0];
    
    let linhaAtual = 1;
    
    // Cabe√ßalho
    sheet.getRange(linhaAtual, 1).setValue('RELAT√ìRIO DE RANKING ESCOLAR').setFontWeight('bold');
    linhaAtual++;
    sheet.getRange(linhaAtual, 1).setValue(`Data: ${dataAtual}`);
    linhaAtual += 2;
    
    // Para cada s√©rie
    for (const serie in relatorio.series) {
      const dadosSerie = relatorio.series[serie];
      
      sheet.getRange(linhaAtual, 1).setValue(`${serie} - Top 20`).setFontWeight('bold');
      linhaAtual++;
      
      // Cabe√ßalhos da tabela
      const cabecalhos = ['Posi√ß√£o', 'Nome', 'Turma', 'M√©dia Geral', '3¬∫ Bim', '4¬∫ Bim', '5¬∫ Conceito'];
      cabecalhos.forEach((cabecalho, index) => {
        sheet.getRange(linhaAtual, index + 1).setValue(cabecalho).setFontWeight('bold');
      });
      linhaAtual++;
      
      // Dados
      dadosSerie.top20.forEach((aluno, index) => {
        const medalha = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}¬∫`;
        
        sheet.getRange(linhaAtual, 1).setValue(medalha);
        sheet.getRange(linhaAtual, 2).setValue(aluno.nome);
        sheet.getRange(linhaAtual, 3).setValue(aluno.turma);
        sheet.getRange(linhaAtual, 4).setValue(parseFloat(aluno.mediaGeral));
        sheet.getRange(linhaAtual, 5).setValue(parseFloat(aluno.mediaBim3));
        sheet.getRange(linhaAtual, 6).setValue(parseFloat(aluno.mediaBim4));
        sheet.getRange(linhaAtual, 7).setValue(parseFloat(aluno.mediaConceito5));
        linhaAtual++;
      });
      
      linhaAtual += 2;
    }
    
    // Ajustar colunas
    for (let i = 1; i <= 7; i++) {
      sheet.autoResizeColumn(i);
    }
    
    // Mostrar URL
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      '‚úÖ Exporta√ß√£o Conclu√≠da',
      `Planilha criada com sucesso!\n\nAcesse: ${novaPlanilha.getUrl()}`,
      ui.ButtonSet.OK
    );
    
  } catch (error) {
    console.error("‚ùå Erro ao exportar para planilha:", error);
  }
}

// ============================================
// INICIALIZA√á√ÉO DO SISTEMA
// ============================================

/**
 * Inicializa o sistema (executar uma vez)
 */
function instalarSistema() {
  try {
    console.log("üöÄ Instalando Sistema de Ranking...");
    
    // 1. Configurar menu
    criarMenu();
    
    // 2. Configurar triggers
    configurarTriggers();
    
    // 3. Executar primeira an√°lise
    registrarMediasBancoDados();
    
    console.log("‚úÖ Sistema instalado com sucesso!");
    
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      '‚úÖ Sistema Instalado',
      'O Sistema de Ranking foi instalado com sucesso!\n\n' +
      'Recarregue a planilha para ver o menu "üèÜ SISTEMA DE RANKING".',
      ui.ButtonSet.OK
    );
    
  } catch (error) {
    console.error("‚ùå Erro na instala√ß√£o:", error);
    const ui = SpreadsheetApp.getUi();
    ui.alert(
      '‚ùå Erro na Instala√ß√£o',
      `Ocorreu um erro na instala√ß√£o:\n\n${error.message}`,
      ui.ButtonSet.OK
    );
  }
}

// ============================================
// FUN√á√ÉO PRINCIPAL DE EXECU√á√ÉO
// ============================================

/**
 * Fun√ß√£o principal para execu√ß√£o manual
 */
function main() {
  try {
    const resultado = registrarMediasBancoDados();
    
    if (resultado.success) {
      console.log("‚úÖ Execu√ß√£o conclu√≠da com sucesso!");
      console.log("üìä Dados registrados na planilha de destino");
      console.log("üèÜ Rankings atualizados no cabe√ßalho");
    } else {
      console.error("‚ùå Erro na execu√ß√£o:", resultado.error);
    }
    
    return resultado;
  } catch (error) {
    console.error("‚ùå Erro na execu√ß√£o principal:", error);
    return { success: false, error: error.message };
  }
}

// ============================================
// DOCUMENTA√á√ÉO DO SISTEMA
// ============================================

/**
 * DOCUMENTA√á√ÉO DO SISTEMA:
 * 
 * 1. ESTRUTURA:
 *    - Planilha Fonte: "Map√£o" (dados originais)
 *    - Planilha Destino: "DANCO_DE_DADOS" (resultados)
 *    
 * 2. FUNCIONALIDADES:
 *    ‚úÖ Analisa notas de todas as disciplinas
 *    ‚úÖ Calcula m√©dias do 3¬∫ e 4¬∫ bimestres
 *    ‚úÖ Calcula 5¬∫ Conceito (m√©dia anual)
 *    ‚úÖ Classifica TOP 20 de cada s√©rie
 *    ‚úÖ Mostra TOP 1, TOP 2, TOP 3 no cabe√ßalho
 *    ‚úÖ Interface com menu personalizado
 *    ‚úÖ Sistema de cache para otimiza√ß√£o
 *    ‚úÖ Atualiza√ß√£o autom√°tica di√°ria
 *    ‚úÖ Formata√ß√£o condicional
 *    ‚úÖ Relat√≥rios e exporta√ß√µes
 *    
 * 3. COMO USAR:
 *    a) Executar uma vez: instalarSistema()
 *    b) Menu na planilha fornece todas as op√ß√µes
 *    c) Atualiza√ß√£o autom√°tica √†s 6h diariamente
 *    
 * 4. INTERVALOS REGISTRADOS:
 *    - 6¬∫ Ano: D3:J22
 *    - 7¬∫ Ano: D29:J48
 *    - 8¬∫ Ano: D55:J74
 *    - 9¬∫ Ano: D81:J100
 *    - 1¬™ S√©rie: D107:J126
 *    - 2¬™ S√©rie: D133:J152
 *    - 3¬™ S√©rie: D159:J178
 *    
 * 5. CABE√áALHO EXIBIDO (c√©lula A1):
 *    - TOP 20 de cada s√©rie
 *    - TOP 1, TOP 2, TOP 3
 *    - Bimestre atual
 *    - 5¬∫ Conceito
 */

// Exportar fun√ß√µes principais para uso externo
if (typeof module !== 'undefined') {
  module.exports = {
    main,
    registrarMediasBancoDados,
    analisarTodasTurmas,
    consultarRankingAluno,
    inicializarSistema,
    instalarSistema
  };
}