<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Conselho de Classe</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --nota-baixa: #ff5252;
            --nota-alta: #2196f3;
            --faltas-cor: #757575;
            --card-bg: #4a5568;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), #1a252f);
            color: white;
            padding: 18px 0;
            text-align: center;
            border-radius: 12px 12px 0 0;
            margin-bottom: 25px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
        }
        
        h1 {
            font-size: 2.2rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            margin: 0;
        }
        
        .controls-panel {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 18px 25px 23px;
            border-radius: 12px;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.1),
                0 4px 6px rgba(0,0,0,0.05),
                inset 0 1px 0 rgba(255,255,255,0.8);
            margin-bottom: 25px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            position: relative;
            border: 1px solid rgba(255,255,255,0.5);
            margin-top: -12px;
            gap: 20px;
        }
        
        .controls-panel::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 2%;
            right: 2%;
            height: 18px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
            border-radius: 50%;
            filter: blur(8px);
            z-index: -1;
        }
        
        .nav-btn {
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 
                0 5px 0 #1a5276,
                0 8px 15px rgba(0,0,0,0.2);
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 140px;
            flex-shrink: 0;
        }
        
        .nav-btn:hover {
            background: linear-gradient(145deg, #3cb0fd, #3498db);
            transform: translateY(-3px);
            box-shadow: 
                0 8px 0 #1a5276,
                0 12px 20px rgba(0,0,0,0.25);
        }
        
        .nav-btn:active {
            transform: translateY(4px);
            box-shadow: 
                0 1px 0 #1a5276,
                0 3px 8px rgba(0,0,0,0.2);
        }
        
        .nav-btn:disabled {
            background: linear-gradient(145deg, #bdc3c7, #95a5a6);
            box-shadow: 
                0 4px 0 #7f8c8d,
                0 6px 10px rgba(0,0,0,0.1);
            cursor: not-allowed;
            transform: none;
        }
        
        .nav-btn:disabled:active {
            transform: none;
            box-shadow: 
                0 4px 0 #7f8c8d,
                0 6px 10px rgba(0,0,0,0.1);
        }
        
        .nav-btn.prev {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            box-shadow: 
                0 5px 0 #a93226,
                0 8px 15px rgba(0,0,0,0.2);
        }
        
        .nav-btn.prev:hover {
            background: linear-gradient(145deg, #ec7063, #e74c3c);
        }
        
        .controls-center {
            display: flex;
            align-items: flex-start;
            gap: 25px;
            flex: 1;
            justify-content: center;
            min-width: 0;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.turma {
            min-width: 150px;
            max-width: 300px;
            flex: 0 1 auto;
        }
        
        .form-group.aluno {
            min-width: 350px;
            max-width: 600px;
            flex: 1 1 auto;
        }
        
        .form-group.btn-container {
            min-width: 140px;
            max-width: 160px;
            flex: 0 0 auto;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 700;
            color: var(--dark-color);
            font-size: 1.05rem;
            text-shadow: 0 1px 1px rgba(255,255,255,0.8);
            white-space: nowrap;
        }
        
        select, input {
            padding: 14px 18px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1.05rem;
            background: linear-gradient(to bottom, #ffffff, #f8f9fa);
            transition: all 0.3s ease;
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.05),
                0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            color: #495057;
            width: 100%;
        }
        
        /* Estilos específicos para os campos de seleção */
        #class-select {
            text-align: center;
            width: auto;
            min-width: 100%;
        }
        
        #student-select {
            width: auto;
            min-width: 100%;
        }
        
        select:focus, input:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 
                inset 0 2px 4px rgba(0,0,0,0.05),
                0 0 0 3px rgba(52, 152, 219, 0.2),
                0 2px 8px rgba(0,0,0,0.1);
            background: linear-gradient(to bottom, #ffffff, #fefefe);
        }
        
        /* Estilo para quando uma turma é selecionada - APENAS O CAMPO */
        #class-select.turma-selecionada {
            background: #ffeb3b !important;
            color: #333 !important;
            font-weight: bold !important;
        }
        
        /* Estilo para lista suspensa de turmas com cores alternadas claro/branco */
        #class-select option:nth-child(even) {
            background-color: #f0f8ff;
        }
        
        #class-select option:nth-child(odd) {
            background-color: #ffffff;
        }
        
        #class-select option:hover {
            background-color: #e1f0ff !important;
        }
        
        #class-select option:checked {
            background-color: #ffeb3b !important;
            color: #000000 !important;
            font-weight: bold !important;
        }
        
        /* Estilo para quando um aluno é selecionado - APENAS O CAMPO */
        #student-select.aluno-selecionado {
            background: #1a237e !important;
            color: #ffffff !important;
            font-weight: bold !important;
        }
        
        /* Estilo para lista suspensa de alunos - TODOS OS NOMES EM NEGRITO E PRETOS */
        #student-select option {
            font-weight: bold !important;
            color: #000000 !important;
        }
        
        #student-select option:nth-child(even) {
            background-color: #f0f8ff;
        }
        
        #student-select option:nth-child(odd) {
            background-color: #ffffff;
        }
        
        #student-select option:hover {
            background-color: #e1f0ff !important;
        }
        
        #student-select option:checked {
            background-color: #d0e7ff !important;
            font-weight: bold;
            color: #000000 !important;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 
                0 4px 6px rgba(0,0,0,0.1),
                0 2px 4px rgba(0,0,0,0.06);
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #3cb0fd, #3498db);
            transform: translateY(-2px);
            box-shadow: 
                0 6px 12px rgba(0,0,0,0.15),
                0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn:active {
            transform: translateY(1px);
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.1),
                0 1px 2px rgba(0,0,0,0.06);
        }
        
        .btn:disabled {
            background: linear-gradient(135deg, #bdc3c7, #95a5a6);
            cursor: not-allowed;
            transform: none;
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.05);
        }
        
        .results-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .bimester-card {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
            max-height: 500px;
        }
        
        .bimester-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .bimester-card.expanded {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            z-index: 1000;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
            display: none;
        }
        
        .bimester-header {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 18px;
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bimester-header:hover {
            background: linear-gradient(135deg, #34495e, #2c3e50);
        }
        
        .bimester-content {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }
        
        .subject-grid {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 1mm;
        }
        
        .subject-cell {
            padding: 10px 12px;
            border-radius: 4px;
            font-weight: 600;
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }
        
        .grade-cell {
            padding: 10px 12px;
            border-radius: 4px;
            font-weight: 700;
            text-align: center;
            min-width: 80px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .grade-cell.nota-baixa {
            background-color: var(--nota-baixa);
            color: white;
        }
        
        .grade-cell.nota-alta {
            background-color: var(--nota-alta);
            color: white;
        }
        
        .grade-cell.sem-nota {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        .faltas-cell {
            padding: 10px 12px;
            border-radius: 4px;
            font-weight: 700;
            text-align: center;
            min-width: 80px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #6c757d;
            font-size: 0.95rem;
            padding: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: var(--dark-color);
            font-size: 1.1rem;
        }
        
        .error {
            background: linear-gradient(135deg, #ffeaea, #ffdada);
            color: var(--accent-color);
            padding: 20px;
            border-radius: 8px;
            margin: 25px 0;
            text-align: center;
            border-left: 4px solid var(--accent-color);
            font-weight: 600;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            grid-column: 1 / -1;
        }
        
        @media (max-width: 1200px) {
            .results-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 1024px) {
            .controls-panel {
                flex-direction: column;
                gap: 20px;
            }
            
            .controls-center {
                width: 100%;
                order: 2;
            }
            
            .nav-btn.prev {
                order: 1;
            }
            
            .nav-btn.next {
                order: 3;
            }
            
            .form-group, .form-group.turma, .form-group.aluno, .form-group.btn-container {
                min-width: 100%;
                max-width: 100%;
                width: 100%;
            }
            
            .form-group.aluno {
                flex: 1;
            }
            
            #class-select, #student-select {
                width: 100%;
            }
            
            .bimester-card.expanded {
                width: 90%;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .controls-panel {
                padding: 15px 20px 20px;
            }
            
            .results-container {
                grid-template-columns: 1fr;
            }
            
            select, input {
                padding: 12px 15px;
            }
            
            .subject-grid {
                grid-template-columns: 1fr;
                gap: 2mm;
            }
            
            .subject-cell, .grade-cell, .faltas-cell {
                min-width: 100%;
            }
            
            .bimester-card.expanded {
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CONSELHO DE CLASSE E SÉRIE</h1>
        </header>
        
        <div class="controls-panel">
            <button id="prev-btn" class="nav-btn prev" disabled>← VOLTAR</button>
            
            <div class="controls-center">
                <div class="form-group turma">
                    <label for="class-select">Selecione a Turma:</label>
                    <select id="class-select">
                        <option value="">-- Selecione uma turma --</option>
                    </select>
                </div>
                
                <div class="form-group aluno">
                    <label for="student-select">Selecione o Aluno:</label>
                    <select id="student-select" disabled>
                        <option value="">-- Primeiro selecione uma turma --</option>
                    </select>
                </div>
                
                <div class="form-group btn-container">
                    <button id="load-data" class="btn" disabled>Carregar Dados</button>
                </div>
            </div>
            
            <button id="next-btn" class="nav-btn next" disabled>AVANÇAR →</button>
        </div>
        
        <div id="results" class="results-container">
            <div class="no-data">Selecione uma turma e um aluno para visualizar os dados</div>
        </div>
        
        <div class="footer">
            <p>Sistema de Acompanhamento Escolar &copy; 2024</p>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <script>
      // URL DO WEB APP
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzuNk65pBReNfhlawYDr_wkHBprIXAX0IqPrhY5xps-_H8mSyHhwy6krkQS2VmG2cNw/exec';

      // Elementos DOM
      const classSelect = document.getElementById('class-select');
      const studentSelect = document.getElementById('student-select');
      const loadButton = document.getElementById('load-data');
      const resultsContainer = document.getElementById('results');
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      const overlay = document.getElementById('overlay');

      // Variáveis globais para navegação
      let currentStudents = [];
      let currentStudentIndex = -1;
      let currentTurma = '';
      let currentExpandedCard = null;

      /* ===================== CARREGAR TURMAS ===================== */
      async function populateClassSelect() {
        try {
          showLoading('Carregando turmas...');

          const response = await fetch(`${WEB_APP_URL}?action=getTurmas`);
          const turmas = await response.json();

          if (turmas.error) throw new Error(turmas.error);

          classSelect.innerHTML = '<option value="">-- Selecione uma turma --</option>';
          turmas.forEach(turma => {
            const option = document.createElement('option');
            option.value = turma;
            option.textContent = turma;
            classSelect.appendChild(option);
          });

          hideLoading();

          // Ajustar a largura do campo de turmas baseado no conteúdo
          adjustClassSelectWidth();
        } catch (err) {
          showError("Erro ao carregar turmas.");
          console.error(err);
        }
      }

      // Função para ajustar a largura do campo de turmas
      function adjustClassSelectWidth() {
        let maxWidth = 0;
        Array.from(classSelect.options).forEach(option => {
          const text = option.textContent;
          const tempSpan = document.createElement('span');
          tempSpan.style.visibility = 'hidden';
          tempSpan.style.position = 'absolute';
          tempSpan.style.whiteSpace = 'nowrap';
          tempSpan.style.fontSize = '1.05rem';
          tempSpan.style.fontFamily = 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
          tempSpan.textContent = text;
          document.body.appendChild(tempSpan);
          const textWidth = tempSpan.offsetWidth;
          document.body.removeChild(tempSpan);
          if (textWidth > maxWidth) maxWidth = textWidth;
        });

        const padding = 60;
        const newWidth = Math.min(Math.max(maxWidth + padding, 150), 300);
        classSelect.style.width = `${newWidth}px`;
      }

      /* ===================== CARREGAR ALUNOS ===================== */
      classSelect.addEventListener('change', async function () {
        const turma = this.value;

        if (turma) classSelect.classList.add('turma-selecionada');
        else classSelect.classList.remove('turma-selecionada');

        studentSelect.disabled = true;
        loadButton.disabled = true;
        prevBtn.disabled = true;
        nextBtn.disabled = true;

        if (!turma) {
          studentSelect.innerHTML = '<option value="">-- Primeiro selecione uma turma --</option>';
          showNoData();
          return;
        }

        studentSelect.innerHTML = '<option>Carregando alunos...</option>';

        try {
          const response = await fetch(`${WEB_APP_URL}?action=getAlunos&turma=${encodeURIComponent(turma)}`);
          const alunos = await response.json();

          if (alunos.error) throw new Error(alunos.error);

          studentSelect.innerHTML = '<option value="">-- Selecione um aluno --</option>';

          // Armazena a lista de alunos para navegação
          currentStudents = Array.isArray(alunos) ? alunos : [];
          currentTurma = turma;

          currentStudents.forEach((a) => {
            const option = document.createElement('option');
            option.value = a;
            option.textContent = a;
            studentSelect.appendChild(option);
          });

          studentSelect.disabled = false;

          // Ajustar a largura do campo de alunos baseado no conteúdo
          adjustStudentSelectWidth();

        } catch (err) {
          studentSelect.innerHTML = '<option value="">Erro ao carregar alunos</option>';
          console.error(err);
        }
      });

      // Função para ajustar a largura do campo de alunos
      function adjustStudentSelectWidth() {
        let maxWidth = 0;
        Array.from(studentSelect.options).forEach(option => {
          const text = option.textContent;
          const tempSpan = document.createElement('span');
          tempSpan.style.visibility = 'hidden';
          tempSpan.style.position = 'absolute';
          tempSpan.style.whiteSpace = 'nowrap';
          tempSpan.style.fontSize = '1.05rem';
          tempSpan.style.fontFamily = 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
          tempSpan.textContent = text;
          document.body.appendChild(tempSpan);
          const textWidth = tempSpan.offsetWidth;
          document.body.removeChild(tempSpan);
          if (textWidth > maxWidth) maxWidth = textWidth;
        });

        const padding = 60;
        const newWidth = Math.min(Math.max(maxWidth + padding, 350), 600);
        studentSelect.style.width = `${newWidth}px`;
      }

      /* Habilitar botão quando aluno for selecionado */
      studentSelect.addEventListener('change', function () {
        const hasStudent = !!this.value;
        loadButton.disabled = !hasStudent;

        if (hasStudent) studentSelect.classList.add('aluno-selecionado');
        else studentSelect.classList.remove('aluno-selecionado');

        if (hasStudent) {
          currentStudentIndex = currentStudents.indexOf(this.value);
          updateNavigationButtons();
        } else {
          currentStudentIndex = -1;
          prevBtn.disabled = true;
          nextBtn.disabled = true;
        }
      });

      /* ===================== NAVEGAÇÃO ENTRE ALUNOS ===================== */
      function updateNavigationButtons() {
        prevBtn.disabled = currentStudentIndex <= 0;
        nextBtn.disabled = currentStudentIndex >= currentStudents.length - 1 || currentStudents.length === 0;
      }

      async function navigateStudents(direction) {
        if (direction === 'prev' && currentStudentIndex > 0) {
          currentStudentIndex--;
        } else if (direction === 'next' && currentStudentIndex < currentStudents.length - 1) {
          currentStudentIndex++;
        } else {
          return;
        }

        studentSelect.value = currentStudents[currentStudentIndex];
        studentSelect.classList.add('aluno-selecionado');

        // Carrega os dados do aluno automaticamente
        await loadStudentData();
        updateNavigationButtons();
      }

      prevBtn.addEventListener('click', () => navigateStudents('prev'));
      nextBtn.addEventListener('click', () => navigateStudents('next'));

      /* ===================== CARREGAR DADOS DO ALUNO ===================== */
      loadButton.addEventListener('click', loadStudentData);

      async function loadStudentData() {
        const turma = classSelect.value;
        const aluno = studentSelect.value;

        currentStudentIndex = currentStudents.indexOf(aluno);
        updateNavigationButtons();

        showLoading("Carregando dados...");

        try {
          const response = await fetch(`${WEB_APP_URL}?action=getDadosAluno&turma=${encodeURIComponent(turma)}&aluno=${encodeURIComponent(aluno)}`);
          const dados = await response.json();

          if (dados.error) throw new Error(dados.error);

          // Novo formato: objeto direto (não dados.dados)
          // Verifica estrutura mínima esperada
          const hasNotas = Array.isArray(dados.notas) && dados.notas.length >= 1;
          const hasDisciplinas = Array.isArray(dados.disciplinas);
          if (!hasNotas || !hasDisciplinas) {
            console.error("Resposta do backend:", dados);
            showError("Estrutura de dados inválida.");
            return;
          }

          // normalize shape: garantir indices 0..3 (bimestres)
          // garantir que notas/faltas sejam arrays de 4 arrays (pode vir como array[0..3])
          const notas = Array.isArray(dados.notas) ? dados.notas : [];
          const faltas = Array.isArray(dados.faltas) ? dados.faltas : [[],[],[],[]];
          const disciplinas = Array.isArray(dados.disciplinas) ? dados.disciplinas : [];
          const conceito5 = Array.isArray(dados.conceito5) ? dados.conceito5 : [];
          const coresConceito5 = Array.isArray(dados.coresConceito5) ? dados.coresConceito5 : [];
          const totalFaltasPorDisciplina = Array.isArray(dados.totalFaltasPorDisciplina) ? dados.totalFaltasPorDisciplina : [];
          const faltasTotal = typeof dados.faltasTotal === 'number' ? dados.faltasTotal : (totalFaltasPorDisciplina.reduce((a,b)=>a+(b||0),0) || 0);

          displayStudentData({ disciplinas, notas, faltas, conceito5, coresConceito5, totalFaltasPorDisciplina, faltasTotal, bimestres: dados.bimestres || {} });

        } catch (err) {
          showError("Erro ao carregar dados do aluno.");
          console.error(err);
        }
      }

      /* ===================== EXIBIR DADOS DO ALUNO ===================== */
      function displayStudentData(dados) {
        resultsContainer.innerHTML = "";

        // Valida
        if (!dados || !Array.isArray(dados.disciplinas) || !Array.isArray(dados.notas)) {
          showError("Estrutura de dados inválida.");
          return;
        }

        const disciplinas = dados.disciplinas;
        const disciplinasCount = disciplinas.length || 0;

        // Ensure notas and faltas are arrays of 4 arrays
        const notas = [];
        const faltas = [];
        for (let b = 0; b < 4; b++) {
          notas[b] = Array.isArray(dados.notas[b]) ? dados.notas[b] : new Array(disciplinasCount).fill(null);
          faltas[b] = Array.isArray(dados.faltas[b]) ? dados.faltas[b] : new Array(disciplinasCount).fill(0);
          // if shorter, pad
          if (notas[b].length < disciplinasCount) notas[b] = notas[b].concat(new Array(disciplinasCount - notas[b].length).fill(null));
          if (faltas[b].length < disciplinasCount) faltas[b] = faltas[b].concat(new Array(disciplinasCount - faltas[b].length).fill(0));
        }

        // Cria cards para cada bimestre (1..4)
        for (let b = 0; b < 4; b++) {
          const card = document.createElement('div');
          card.className = "bimester-card";

          const header = document.createElement('div');
          header.className = "bimester-header";
          header.textContent = `${b+1}º Bimestre`;

          // Adiciona funcionalidade de duplo clique para expandir
          header.addEventListener('dblclick', function() {
            toggleCardExpansion(card);
          });

          const content = document.createElement('div');
          content.className = "bimester-content";

          // Cria grid para as disciplinas, notas e faltas
          const grid = document.createElement('div');
          grid.className = "subject-grid";

          // Itera pelas disciplinas
          for (let i = 0; i < disciplinasCount; i++) {
            const nomeDisc = disciplinas[i] || (`Disciplina ${i+1}`);
            const notaRaw = notas[b][i];
            const faltaRaw = faltas[b][i];

            // Célula do nome da disciplina
            const nomeCell = document.createElement("div");
            nomeCell.className = "subject-cell";
            nomeCell.textContent = nomeDisc;

            // Célula da nota
            const gradeCell = document.createElement("div");
            gradeCell.className = "grade-cell";

            let nota = null;
            if (notaRaw !== null && notaRaw !== undefined && notaRaw !== "") {
              const parsed = parseFloat(notaRaw);
              nota = isNaN(parsed) ? null : parsed;
            }

            // Célula das faltas
            const faltasCell = document.createElement("div");
            faltasCell.className = "faltas-cell";

            const falta = (faltaRaw === null || faltaRaw === undefined || faltaRaw === "") ? 0 : (parseInt(faltaRaw) || 0);

            // Aplica a cor baseada na nota
            if (nota !== null) {
              if (nota >= 5) {
                gradeCell.classList.add("nota-alta");
              } else {
                gradeCell.classList.add("nota-baixa");
              }
              gradeCell.textContent = nota.toFixed(1);
            } else {
              gradeCell.classList.add("sem-nota");
              gradeCell.textContent = "--";
            }

            // Preenche a célula de faltas
            faltasCell.textContent = falta;

            grid.appendChild(nomeCell);
            grid.appendChild(gradeCell);
            grid.appendChild(faltasCell);
          }

          content.appendChild(grid);
          card.appendChild(header);
          card.appendChild(content);
          resultsContainer.appendChild(card);
        }

        // 5º CONCEITO (médias e totais)
        const conceitoCard = document.createElement('div');
        conceitoCard.className = "bimester-card";

        const conceitoHeader = document.createElement('div');
        conceitoHeader.className = "bimester-header";
        conceitoHeader.textContent = "5º CONCEITO";
        conceitoHeader.style.background = "linear-gradient(135deg, #27ae60, #2ecc71)";

        // Adiciona funcionalidade de duplo clique para expandir
        conceitoHeader.addEventListener('dblclick', function() {
          toggleCardExpansion(conceitoCard);
        });

        const conceitoContent = document.createElement('div');
        conceitoContent.className = "bimester-content";

        // Cria grid para as disciplinas e médias
        const grid = document.createElement('div');
        grid.className = "subject-grid";

        // Preferir conceito5 vindo do backend; se não houver, calcula localmente
        let medias = Array.isArray(dados.conceito5) && dados.conceito5.length >= disciplinasCount ? dados.conceito5.slice(0, disciplinasCount) : null;
        if (!medias) {
          medias = new Array(disciplinasCount).fill(null);
          for (let i = 0; i < disciplinasCount; i++) {
            let soma = 0, cont = 0;
            for (let b = 0; b < 4; b++) {
              const n = notas[b][i];
              if (n !== null && n !== undefined && n !== "" && !isNaN(parseFloat(n))) { soma += parseFloat(n); cont++; }
            }
            medias[i] = cont > 0 ? (soma / cont) : null;
          }
        }

        const totalFaltasPorDisciplina = Array.isArray(dados.totalFaltasPorDisciplina) && dados.totalFaltasPorDisciplina.length >= disciplinasCount
          ? dados.totalFaltasPorDisciplina
          : (function() {
              // calcula somando faltas por disciplina
              const totals = new Array(disciplinasCount).fill(0);
              for (let i = 0; i < disciplinasCount; i++) {
                let tot = 0;
                for (let b = 0; b < 4; b++) tot += (parseInt(faltas[b][i]) || 0);
                totals[i] = tot;
              }
              return totals;
            })();

        for (let i = 0; i < disciplinasCount; i++) {
          // Célula do nome da disciplina
          const nomeCell = document.createElement("div");
          nomeCell.className = "subject-cell";
          nomeCell.textContent = disciplinas[i] || (`Disciplina ${i+1}`);

          // Célula da média
          const gradeCell = document.createElement("div");
          gradeCell.className = "grade-cell";

          // Célula das faltas totais
          const faltasCell = document.createElement("div");
          faltasCell.className = "faltas-cell";

          const media = medias[i];
          const faltasDisc = totalFaltasPorDisciplina[i] || 0;

          // Aplica a cor baseada na média
          if (media !== null && media !== undefined && !isNaN(media)) {
            if (media >= 5) {
              gradeCell.classList.add("nota-alta");
            } else {
              gradeCell.classList.add("nota-baixa");
            }
            gradeCell.textContent = media.toFixed(1);
          } else {
            gradeCell.classList.add("sem-nota");
            gradeCell.textContent = "--";
          }

          // Preenche a célula de faltas totais
          faltasCell.textContent = faltasDisc;

          grid.appendChild(nomeCell);
          grid.appendChild(gradeCell);
          grid.appendChild(faltasCell);
        }

        conceitoContent.appendChild(grid);
        conceitoCard.appendChild(conceitoHeader);
        conceitoCard.appendChild(conceitoContent);
        resultsContainer.appendChild(conceitoCard);
      }

      /* ===================== FUNÇÃO PARA EXPANDIR/RETRAIR CARD ===================== */
      function toggleCardExpansion(card) {
        // Se o card já está expandido, retrai
        if (card.classList.contains('expanded')) {
          card.classList.remove('expanded');
          overlay.style.display = 'none';
          currentExpandedCard = null;
        } else {
          // Remove a classe expanded de todos os cards
          document.querySelectorAll('.bimester-card').forEach(c => {
            c.classList.remove('expanded');
          });
          
          // Adiciona a classe expanded no card clicado
          card.classList.add('expanded');
          overlay.style.display = 'block';
          currentExpandedCard = card;
        }
      }

      // Fechar card expandido ao clicar no overlay
      overlay.addEventListener('click', function() {
        if (currentExpandedCard) {
          currentExpandedCard.classList.remove('expanded');
          overlay.style.display = 'none';
          currentExpandedCard = null;
        }
      });

      /* ===================== FUNÇÕES DE AUXÍLIO ===================== */
      function showLoading(msg) {
        resultsContainer.innerHTML = `<div class="loading">${msg}</div>`;
      }

      function hideLoading() {
        const loading = resultsContainer.querySelector('.loading');
        if (loading) loading.remove();
      }

      function showError(msg) {
        resultsContainer.innerHTML = `<div class="error">${msg}</div>`;
      }

      function showNoData() {
        resultsContainer.innerHTML = '<div class="no-data">Selecione uma turma e um aluno para visualizar os dados</div>';
      }

      /* ===================== INICIAR ===================== */
      document.addEventListener("DOMContentLoaded", populateClassSelect);
    </script>
</body>
</html>
